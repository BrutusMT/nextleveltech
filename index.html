<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz de Sistemas Operacionais</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Estilos Globais e de Fundo */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #e0f2f7 0%, #bbdefb 100%); /* Gradiente de azul claro */
            color: #333;
            overflow-x: hidden; /* Evita barra de rolagem horizontal */
        }

        .container {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            max-width: 900px; /* Aumenta a largura máxima para o relatório */
            width: 100%;
            box-sizing: border-box;
            opacity: 0; /* Começa invisível e é mostrado pelo JS */
            transform: translateY(20px);
            animation: fadeIn 0.6s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1, h2, h3 {
            color: #1a237e; /* Azul escuro para títulos */
            margin-bottom: 20px;
        }

        /* Estilos dos Botões de Ação */
        .action-button {
            background-color: #4285f4; /* Azul Google */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-decoration: none; /* Para botões que são links */
            display: inline-block; /* Para que margin e padding funcionem */
        }

        .action-button:hover {
            background-color: #357ae8;
            transform: translateY(-2px);
        }

        .action-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Estilos para Inputs de Texto */
        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: calc(100% - 20px);
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box; /* Garante que padding não aumente a largura */
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        select:focus,
        textarea:focus {
            border-color: #4285f4;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }

        /* --- Login/Registro Pop-up --- */
        #login-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Garante que fique por cima de tudo */
        }

        .auth-form {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-sizing: border-box;
        }

        .auth-form h2 {
            margin-bottom: 25px;
            color: #1a237e;
        }

        .auth-form .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .auth-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .auth-form input[type="text"],
        .auth-form input[type="password"] {
            width: 100%; /* Ocupa 100% do form-group */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }

        .auth-form button {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            font-size: 1.1em;
            background-color: #1a73e8; /* Azul mais forte */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .auth-form button:hover {
            background-color: #0f62d1;
        }

        .auth-form .toggle-link {
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .auth-form .toggle-link a {
            color: #4285f4;
            text-decoration: none;
            font-weight: bold;
        }

        .auth-form .toggle-link a:hover {
            text-decoration: underline;
        }

        /* --- Tela Inicial (Start Screen) --- */
        #start-screen {
            display: flex; /* Para centralizar o conteúdo */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 250px; /* Altura mínima para o conteúdo inicial */
        }

        #start-screen h2 {
            margin-bottom: 30px;
        }

        #start-screen input[type="text"] {
            margin-bottom: 20px;
            max-width: 300px;
            text-align: center;
        }

        /* --- Seção do Quiz --- */
        #quiz {
            display: none; /* Escondido por padrão */
            text-align: center;
        }

        #question-text {
            font-size: 1.4em;
            margin-bottom: 25px;
            color: #1a237e;
            min-height: 80px; /* Para evitar saltos no layout */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
        }

        #question-text img {
            max-width: 100%; /* Garante que a imagem se ajuste ao contêiner */
            max-height: 200px; /* Limita a altura da imagem */
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }

        .option-button {
            background-color: #e3f2fd; /* Azul clarinho para opções */
            color: #1a237e;
            border: 1px solid #90caf9;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease, border-color 0.3s ease;
            text-align: left;
        }

        .option-button:hover {
            background-color: #bbdefb;
            transform: translateY(-2px);
        }

        .option-button.selected {
            background-color: #4285f4; /* Azul forte quando selecionado */
            color: white;
            border-color: #2b70f4;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        /* Esconder div de resultado temporariamente */
        #result {
            display: none;
        }

        /* --- Seção de Relatório --- */
        #report-section {
            display: none; /* Escondido por padrão */
            text-align: left;
            padding: 20px;
            background-color: #f8fcfd; /* Fundo ligeiramente diferente para o relatório */
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            max-width: 800px; /* Garante que o relatório não fique muito largo */
            margin: 0 auto;
        }

        #report-summary {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #report-summary p {
            font-size: 1.1em;
            margin: 8px 0;
            color: #333;
        }

        #report-summary p strong {
            color: #1a237e;
        }

        #report-score-display {
            font-size: 2.2em;
            font-weight: bold;
            color: #4CAF50; /* Verde para o score */
            margin: 15px 0;
        }

        #report-score-display .total-questions {
            font-size: 0.6em;
            color: #555;
        }

        /* Estilos dos gráficos */
        .chart-container {
            width: 100%;
            max-width: 450px; /* Limita a largura dos gráficos */
            margin: 20px auto;
            background-color: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .chart-container canvas {
            max-height: 350px; /* Altura máxima para os gráficos */
        }

        #report-buttons {
            display: flex;
            flex-wrap: wrap; /* Permite que os botões quebrem a linha */
            justify-content: center;
            margin-top: 30px;
            gap: 15px; /* Espaço entre os botões */
        }

        #detailed-results {
            margin-top: 40px;
            border-top: 2px solid #bbdefb;
            padding-top: 30px;
            text-align: left;
        }

        #detailed-results h3 {
            color: #1a237e;
            margin-bottom: 20px;
            text-align: center;
        }

        /* --- OTIMIZAÇÃO PARA PDF: Novos estilos para o relatório detalhado --- */
        #detailed-results.pdf-mode ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #detailed-results.pdf-mode li {
            font-size: 0.8em; /* Fonte ainda menor */
            line-height: 1.2; /* Espaçamento de linha mais compacto */
            margin-bottom: 3px; /* Menos margem entre itens */
            color: #333;
        }

        #detailed-results.pdf-mode li .q-num {
            font-weight: bold;
            color: #1a237e;
        }
        #detailed-results.pdf-mode li .q-text {
            font-weight: bold;
            color: #1a237e;
            display: inline; /* Faz com que o texto da pergunta fique na mesma linha */
        }

        #detailed-results.pdf-mode li .user-answer-pdf {
            font-weight: normal;
            color: #4285f4;
        }
        #detailed-results.pdf-mode li .correct-answer-pdf {
            font-weight: normal;
            color: #4CAF50;
        }
        #detailed-results.pdf-mode li .status-correct {
            color: #4CAF50;
            font-weight: bold;
        }
        #detailed-results.pdf-mode li .status-incorrect {
            color: #F44336;
            font-weight: bold;
        }

        /* Esconder elementos específicos para a exportação (visível apenas no CSS do PDF) */
        .hide-for-pdf {
            display: none !important;
        }


        /* Estilos para o modo de exibição normal (não-PDF) */
        .question-result {
            background-color: #f0f8ff; /* Fundo mais claro para cada pergunta */
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            line-height: 1.6;
        }

        .question-result.correct-q {
            border-left: 5px solid #4CAF50; /* Borda verde para acertos */
        }

        .question-result.wrong-q {
            border-left: 5px solid #F44336; /* Borda vermelha para erros */
        }

        .question-result .q-text {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #1a237e;
        }

        .question-result .user-answer {
            font-weight: bold;
            color: #4285f4; /* Azul para a resposta do usuário */
        }

        .question-result .correct-answer {
            font-weight: bold;
            color: #4CAF50; /* Verde para a resposta correta */
        }

        .question-result .attempt-count-report {
            font-size: 0.9em;
            color: #777;
            margin-top: 10px;
        }

        /* --- Painel Administrativo --- */
        #admin-panel {
            display: none; /* Escondido por padrão */
            flex-direction: column;
            width: 100%;
            max-width: 900px;
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            text-align: left;
            box-sizing: border-box;
            min-height: 80vh; /* Ocupa mais espaço na tela */
            position: relative; /* Para posicionar o botão de fechar */
        }

        #admin-panel h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        #admin-panel .action-button {
            margin-bottom: 20px;
        }

        #questions-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        #questions-list li {
            background-color: #f0f8ff;
            border: 1px solid #bbdefb;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        #questions-list li strong {
            color: #1a237e;
            font-size: 1.1em;
        }

        #questions-list li span {
            font-size: 0.95em;
            color: #555;
        }

        #questions-list li .actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        #questions-list li .edit-btn,
        #questions-list li .delete-btn {
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        #questions-list li .edit-btn {
            background-color: #ffc107; /* Amarelo */
            color: #333;
            border: none;
        }

        #questions-list li .edit-btn:hover {
            background-color: #ffb300;
        }

        #questions-list li .delete-btn {
            background-color: #f44336; /* Vermelho */
            color: white;
            border: none;
        }

        #questions-list li .delete-btn:hover {
            background-color: #d32f2f;
        }

        #close-admin-panel-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #555;
            transition: color 0.3s ease;
        }

        #close-admin-panel-button:hover {
            color: #1a237e;
        }

        /* --- Modal de Edição/Adição de Pergunta --- */
        #edit-question-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Escondido por padrão */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: left;
            width: 90%;
            max-width: 600px;
            box-sizing: border-box;
            position: relative;
        }

        .modal-content h3 {
            text-align: center;
            margin-bottom: 25px;
            color: #1a237e;
        }

        .modal-content .form-group {
            margin-bottom: 15px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-content .modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .modal-content #save-question-button {
            background-color: #4CAF50; /* Verde */
            color: white;
            border: none;
        }

        .modal-content #save-question-button:hover {
            background-color: #43a047;
        }

        .modal-content #cancel-edit-button {
            background-color: #f44336; /* Vermelho */
            color: white;
            border: none;
        }

        .modal-content #cancel-edit-button:hover {
            background-color: #d32f2f;
        }

        /* Contador de Tentativas */
        .attempt-count {
            font-size: 0.7em;
            color: #777;
            margin-left: 10px;
        }


        /* Media Queries para Responsividade */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 15px;
            }

            .option-button {
                padding: 12px 15px;
                font-size: 1em;
            }

            .action-button {
                padding: 10px 20px;
                font-size: 0.9em;
            }

            #report-summary p {
                font-size: 1em;
            }

            #report-score-display {
                font-size: 1.8em;
            }

            .chart-container {
                max-width: 95%;
            }

            #admin-panel {
                padding: 20px;
                margin: 15px;
            }

            .modal-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.4em;
            }
            .action-button {
                width: 100%;
                margin: 5px 0;
            }
            .navigation-buttons {
                flex-direction: column;
                gap: 10px;
            }
            #report-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="login-popup">
        <div class="auth-form">
            <h2 id="form-title">Acessar Quiz</h2>

            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">Usuário:</label>
                    <input type="text" id="login-username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Senha:</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="button" id="login-button">Login</button>
                <p class="toggle-link">Não tem uma conta? <a href="#" id="show-register-button">Registre-se</a></p>
            </form>

            <form id="register-form" style="display: none;">
                <div class="form-group">
                    <label for="register-username">Novo Usuário:</label>
                    <input type="text" id="register-username" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Senha:</label>
                    <input type="password" id="register-password" required>
                </div>
                <div class="form-group">
                    <label for="register-password-confirm">Confirmar Senha:</label>
                    <input type="password" id="register-password-confirm" required>
                </div>
                <button type="button" id="register-button">Registrar</button>
                <p class="toggle-link">Já tem uma conta? <a href="#" id="show-login-button">Fazer Login</a></p>
            </form>
        </div>
    </div>

    <div id="main-content-wrapper" class="container" style="display: none;">
        <h1>Bem-vindo(a) ao Quiz de Sistemas Operacionais!</h1>

        <div id="start-screen">
            <h2>Pronto para testar seus conhecimentos?</h2>
            <p>Seu nome será preenchido automaticamente com seu usuário de login.</p>
            <input type="text" id="student-name-input" placeholder="Nome do Aluno(a)" readonly>
            <a href="https://example.com/seu-conteudo-teorico" target="_blank" id="content-link-button" class="action-button" style="display: none;">Acessar Conteúdo Teórico</a>
            <button id="start-quiz-button" class="action-button">Iniciar Quiz</button>
        </div>

        <div id="quiz">
            <p id="question-text"></p>
            <div id="options-container"></div>
            <div class="navigation-buttons">
                <button id="prev-button" class="action-button">Anterior</button>
                <button id="next-button" class="action-button">Próxima</button>
            </div>
            <div id="result"></div>
        </div>

        <div id="report-section">
            <h2>Relatório de Desempenho</h2>
            <div id="report-summary">
                <p>Aluno(a): <strong id="report-student-name"></strong></p>
                <p>Tempo Total: <strong id="report-time-taken"></strong> segundos</p>
                <div id="report-score-display">
                    <span id="report-score"></span> / <span id="report-total-questions"></span>
                    <br>
                    <span class="total-questions">(<span id="report-average"></span>% de acerto)</span>
                </div>
            </div>

            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
                <div class="chart-container">
                    <canvas id="report-canvas"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="area-report-canvas"></canvas>
                </div>
            </div>


            <div id="report-buttons">
                <button id="restart-button-report" class="action-button">Reiniciar Quiz</button>
                <button id="export-pdf-button" class="action-button">Exportar PDF</button>
                <button id="export-sheets-button" class="action-button">Exportar para Planilhas Google</button>
                <button id="next-activity-button" class="action-button">Próxima Atividade</button>
            </div>

            <div id="detailed-results"></div>
        </div>
    </div>

    <div id="admin-panel">
        <button id="close-admin-panel-button">&times;</button>
        <h2>Painel de Controle do Admin</h2>
        <button id="add-question-button" class="action-button">Adicionar Nova Pergunta</button>
        <h3>Perguntas Cadastradas:</h3>
        <ul id="questions-list"></ul>
    </div>

    <div id="edit-question-modal">
        <div class="modal-content">
            <h3 id="edit-modal-title">Editar Pergunta</h3>
            <input type="hidden" id="edit-question-id">
            <div class="form-group">
                <label for="edit-question-topic">Tópico:</label>
                <select id="edit-question-topic">
                    <option value="Processos">Processos</option>
                    <option value="Threads">Threads</option>
                    <option value="Comunicação interprocessos (IPC)">Comunicação interprocessos (IPC)</option>
                    <option value="Escalonamento">Escalonamento</option>
                    <option value="Uso direto de memória">Uso direto de memória</option>
                    <option value="Abstração de memória: espaço de endereçamento">Abstração de memória: espaço de endereçamento</option>
                    <option value="Memória virtual">Memória virtual</option>
                    <option value="Algoritmos de substituição de páginas">Algoritmos de substituição de páginas</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-question-text">Pergunta:</label>
                <textarea id="edit-question-text" rows="3" required></textarea>
            </div>
            <button id="fetch-image-button" type="button" class="action-button" style="margin-top: 10px; margin-bottom: 5px;">
                Buscar Imagem
            </button>
            <div class="form-group">
                <label for="edit-question-image">URL da Imagem (Opcional):</label>
                <input type="text" id="edit-question-image" placeholder="Ex: https://example.com/imagem.jpg">
            </div>
            <div class="form-group">
                <label>Opções de Resposta:</label>
                <input type="text" id="edit-option-1" placeholder="Opção 1" required>
                <input type="text" id="edit-option-2" placeholder="Opção 2" required>
                <input type="text" id="edit-option-3" placeholder="Opção 3">
                <input type="text" id="edit-option-4" placeholder="Opção 4">
            </div>
            <div class="form-group">
                <label for="edit-correct-answer">Resposta Correta:</label>
                <select id="edit-correct-answer" required></select>
            </div>
            <div class="modal-buttons">
                <button id="save-question-button">Salvar</button>
                <button id="cancel-edit-button">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
const initialQuestions = [
    // --- Gerência de Processos: Definição e Estrutura Fundamental ---
    { id: 1, topic: "Processos", question: "Qual a definição de um processo em um sistema operacional?", options: ["Um arquivo de texto salvo no disco.", "Uma instância de um programa em execução.", "Um componente de hardware da CPU.", "Uma pasta de arquivos organizada."], answer: "Uma instância de um programa em execução.", image: "https://source.unsplash.com/random/400x300/?program,running,computer" },
    { id: 2, topic: "Processos", question: "Qual atributo essencial ajuda a identificar unicamente um processo?", options: ["Tamanho do arquivo.", "Data de criação.", "PID (Identificador de Processo).", "Cor do ícone."], answer: "PID (Identificador de Processo).", image: "https://source.unsplash.com/random/400x300/?ID,number,tag" },
    { id: 3, topic: "Processos", question: "O que o 'estado' de um processo representa?", options: ["A prioridade do processo.", "O status atual de sua execução (ex: novo, pronto, em execução, terminado).", "O nome do usuário que o iniciou.", "A quantidade de memória que ele consome."], answer: "O status atual de sua execução (ex: novo, pronto, em execução, terminado).", image: "https://source.unsplash.com/random/400x300/?process,state,flowchart" },
    { id: 4, topic: "Processos", question: "Onde o kernel do sistema operacional armazena as informações de um processo?", options: ["Diretamente no programa executável.", "Em estruturas de dados como 'proc' e 'user'.", "Em arquivos temporários na área de trabalho.", "No cache da CPU."], answer: "Em estruturas de dados como 'proc' e 'user'.", image: "https://source.unsplash.com/random/400x300/?kernel,data,structure" },
    { id: 5, topic: "Processos", question: "A compreensão da estrutura de um processo é vital para qual propósito?", options: ["Decorar o sistema operacional.", "Otimizar o uso dos recursos do sistema e garantir a estabilidade das aplicações.", "Apenas para programadores avançados.", "Reduzir o consumo de energia do computador."], answer: "Otimizar o uso dos recursos do sistema e garantir a estabilidade das aplicações.", image: "https://source.unsplash.com/random/400x300/?optimization,stability,system" },

    // --- Threads: Potencializando a Execução Paralela ---
    { id: 6, topic: "Threads", question: "Qual a principal diferença entre um processo e uma thread?", options: ["Um processo é uma casa, uma thread é uma cidade.", "Um processo é uma instância de um programa, uma thread é uma unidade de execução menor dentro desse processo.", "Threads não podem executar código.", "Processos são mais rápidos que threads."], answer: "Um processo é uma instância de um programa, uma thread é uma unidade de execução menor dentro desse processo.", image: "https://source.unsplash.com/random/400x300/?process,thread,comparison" },
    { id: 7, topic: "Threads", question: "Qual a maior vantagem das threads em relação ao compartilhamento de recursos?", options: ["Cada thread tem seu próprio espaço de endereço isolado.", "Elas não compartilham nenhum recurso.", "Todas as threads de um processo compartilham o mesmo espaço de endereço e recursos.", "Elas só podem compartilhar arquivos."], answer: "Todas as threads de um processo compartilham o mesmo espaço de endereço e recursos.", image: "https://source.unsplash.com/random/400x300/?shared,resources,multitasking" },
    { id: 8, topic: "Threads", question: "O uso de threads resulta em quais benefícios para as aplicações?", options: ["Maior consumo de bateria e lentidão.", "Menor eficiência e menor responsividade.", "Maior eficiência e responsividade.", "Apenas complexidade adicional."], answer: "Maior eficiência e responsividade.", image: "https://source.unsplash.com/random/400x300/?efficiency,responsiveness,software" },
    { id: 9, topic: "Threads", question: "Para quais tipos de tarefas as threads são ideais?", options: ["Tarefas que não podem ser divididas.", "Tarefas que exigem recursos exclusivos.", "Tarefas que podem ser divididas em subtarefas independentes (ex: processamento em segundo plano).", "Tarefas simples de digitação."], answer: "Tarefas que podem ser divididas em subtarefas independentes (ex: processamento em segundo plano).", image: "https://source.unsplash.com/random/400x300/?multitasking,concurrent,tasks" },
    { id: 10, topic: "Threads", question: "Qual o impacto das threads em sistemas multi-core?", options: ["Diminui o desempenho.", "Melhora o desempenho.", "Não tem impacto.", "Causa erros no sistema."], answer: "Melhora o desempenho.", image: "https://source.unsplash.com/random/400x300/?multi-core,CPU,performance" },

    // --- Comunicação Interprocessos (IPC): O Diálogo no Sistema ---
    { id: 11, topic: "Comunicação interprocessos (IPC)", question: "O que o mecanismo IPC permite?", options: ["Que processos se isolem completamente.", "Que processos distintos troquem dados e coordenem suas ações.", "Apenas a comunicação entre o sistema operacional e o hardware.", "Apenas a criação de novos processos."], answer: "Que processos distintos troquem dados e coordenem suas ações.", image: "https://source.unsplash.com/random/400x300/?IPC,communication,processes" },
    { id: 12, topic: "Comunicação interprocessos (IPC)", question: "Qual método IPC é um canal unidirecional para comunicação simples?", options: ["Memória Compartilhada.", "Filas de Mensagens.", "Pipes (Tubulações).", "Email."], answer: "Pipes (Tubulações).", image: "https://source.unsplash.com/random/400x300/?pipes,data,flow" },
    { id: 13, topic: "Comunicação interprocessos (IPC)", question: "Como a 'Memória Compartilhada' funciona para troca de dados?", options: ["Envio de mensagens por uma rede.", "Processos acessam diretamente uma região comum da memória.", "Criação de arquivos temporários.", "Envio de sinais de áudio."], answer: "Processos acessam diretamente uma região comum da memória.", image: "https://source.unsplash.com/random/400x300/?shared,memory,data" },
    { id: 14, topic: "Comunicação interprocessos (IPC)", question: "Qual o objetivo de mecanismos de sincronização em IPC (ex: mutexes, semáforos)?", options: ["Aumentar a velocidade do sistema.", "Evitar condições de corrida e garantir a integridade dos dados compartilhados.", "Diminuir o número de processos.", "Apenas para fins de depuração."], answer: "Evitar condições de corrida e garantir a integridade dos dados compartilhados.", image: "https://source.unsplash.com/random/400x300/?synchronization,integrity,data" },
    { id: 15, topic: "Comunicação interprocessos (IPC)", question: "A IPC é a base para qual tipo de interação no sistema operacional?", options: ["Apenas para jogos.", "Apenas para o sistema de arquivos.", "Colaboração entre aplicativos e serviços.", "Apenas para drivers de hardware."], answer: "Colaboração entre aplicativos e serviços.", image: "https://source.unsplash.com/random/400x300/?collaboration,software,system" },

    // --- Escalonamento de Processos: A Arte de Gerenciar o Tempo ---
    { id: 16, topic: "Escalonamento", question: "O que é 'escalonamento' em sistemas operacionais?", options: ["O processo de ligar o computador.", "A decisão de qual processo será executado pela CPU e por quanto tempo.", "A organização de arquivos no disco.", "A instalação de novos programas."], answer: "A decisão de qual processo será executado pela CPU e por quanto tempo.", image: "https://source.unsplash.com/random/400x300/?CPU,scheduling,time" },
    { id: 17, topic: "Escalonamento", question: "Mesmo com um único núcleo de CPU, o escalonamento cria a ilusão de quê?", options: ["Que o computador está desligado.", "Que vários processos estão sendo executados simultaneamente.", "Que apenas um programa pode ser usado por vez.", "Que o teclado não funciona."], answer: "Que vários processos estão sendo executados simultaneamente.", image: "https://source.unsplash.com/random/400x300/?parallel,execution,illusion" },
    { id: 18, topic: "Escalonamento", question: "Na política de escalonamento 'FIFO', como os processos são executados?", options: ["Aleatoriamente.", "Na ordem de chegada.", "Pelo menor tempo de execução.", "Pela maior prioridade."], answer: "Na ordem de chegada.", image: "https://source.unsplash.com/random/400x300/?FIFO,queue,first" },
    { id: 19, topic: "Escalonamento", question: "O que acontece na política 'Round-Robin' após um processo receber um 'quantum de tempo'?", options: ["Ele é terminado.", "Ele é preempcionado e colocado no final da fila de prontos.", "Ele continua executando indefinidamente.", "Ele perde sua prioridade."], answer: "Ele é preempcionado e colocado no final da fila de prontos.", image: "https://source.unsplash.com/random/400x300/?round,robin,quantum" },
    { id: 20, topic: "Escalonamento", question: "Qual política de escalonamento executa processos com maior prioridade primeiro?", options: ["FIFO.", "Round-Robin.", "Prioridades.", "SJF."], answer: "Prioridades.", image: "https://source.unsplash.com/random/400x300/?priority,scheduling,order" },

    // --- Gerência de Memória: Uso Direto e Básico ---
    { id: 21, topic: "Uso direto de memória", question: "Qual a função do sistema operacional no modelo de 'Uso Direto de Memória'?", options: ["Apenas ler arquivos do disco.", "Alocar e liberar blocos de memória para processos e garantir proteção de acesso.", "Controlar o brilho da tela.", "Gerenciar a conexão com a internet."], answer: "Alocar e liberar blocos de memória para processos e garantir proteção de acesso.", image: "https://source.unsplash.com/random/400x300/?memory,allocation,protection" },
    { id: 22, topic: "Uso direto de memória", question: "O uso direto da memória pode levar a quais problemas se não for bem gerenciado?", options: ["Aumento da velocidade do processador.", "Fragmentação e problemas de segurança.", "Apenas a erros de digitação.", "Melhora na organização de arquivos."], answer: "Fragmentação e problemas de segurança.", image: "https://source.unsplash.com/random/400x300/?fragmentation,security,memory" },
    { id: 23, topic: "Uso direto de memória", question: "O que o SO controla em relação à memória alocada?", options: ["Apenas o tamanho do programa.", "Permissões de leitura, escrita e execução para cada segmento de memória.", "O nome do processo.", "A cor do plano de fundo."], answer: "Permissões de leitura, escrita e execução para cada segmento de memória.", image: "https://source.unsplash.com/random/400x300/?permissions,memory,access" },

    // --- Abstração de Memória: O Espaço de Endereçamento ---
    { id: 24, topic: "Abstração de memória: espaço de endereçamento", question: "O que é o 'espaço de endereçamento' de um processo?", options: ["O local físico onde o processo está armazenado.", "Sua própria visão lógica e isolada da memória.", "O tamanho total da RAM do computador.", "A área do disco rígido reservada para backups."], answer: "Sua própria visão lógica e isolada da memória.", image: "https://source.unsplash.com/random/400x300/?memory,address,space" },
    { id: 25, topic: "Abstração de memória: espaço de endereçamento", question: "Qual o papel do sistema operacional em relação aos endereços lógicos e físicos?", options: ["Ele apenas usa endereços físicos.", "Ele mapeia endereços lógicos para endereços físicos reais na RAM.", "Ele não interfere na alocação de memória.", "Ele armazena todos os endereços em um arquivo."], answer: "Ele mapeia endereços lógicos para endereços físicos reais na RAM.", image: "https://source.unsplash.com/random/400x300/?logical,physical,mapping" },
    { id: 26, topic: "Abstração de memória: espaço de endereçamento", question: "Qual a garantia que a abstração de memória oferece?", options: ["Que processos podem acessar a memória uns dos outros.", "Que o sistema operacional não precisa de memória.", "Que um processo não pode acessar acidentalmente ou maliciosamente a memória de outro, garantindo segurança.", "Que a RAM nunca será preenchida."], answer: "Que um processo não pode acessar acidentalmente ou maliciosamente a memória de outro, garantindo segurança.", image: "https://source.unsplash.com/random/400x300/?memory,protection,isolation" },
    { id: 27, topic: "Abstração de memória: espaço de endereçamento", question: "A abstração do espaço de endereçamento é um pilar de qual conceito moderno?", options: ["Monoprogramação.", "Sistemas de arquivo FAT32.", "Multiprogramação, permitindo múltiplos programas rodarem simultaneamente.", "Redes de computadores antigas."], answer: "Multiprogramação, permitindo múltiplos programas rodarem simultaneamente.", image: "https://source.unsplash.com/random/400x300/?multiprogramming,simultaneous,execution" },

    // --- Memória Virtual: Além dos Limites Físicos ---
    { id: 28, topic: "Memória virtual", question: "O que é 'memória virtual'?", options: ["Uma memória RAM extra.", "Uma técnica que expande o espaço de endereçamento usando o disco rígido como extensão da RAM.", "Uma área de armazenamento temporário da CPU.", "Um tipo de memória ROM."], answer: "Uma técnica que expande o espaço de endereçamento usando o disco rígido como extensão da RAM.", image: "https://source.unsplash.com/random/400x300/?virtual,memory,disk" },
    { id: 29, topic: "Memória virtual", question: "O que acontece com páginas de memória menos utilizadas quando a RAM está cheia na memória virtual?", options: ["Elas são permanentemente excluídas.", "São movidas para a área de swap no disco.", "São compactadas e permanecem na RAM.", "São enviadas para a impressora."], answer: "São movidas para a área de swap no disco.", image: "https://source.unsplash.com/random/400x300/?swap,file,memory,paging" },
    { id: 30, topic: "Memória virtual", question: "Qual um dos benefícios essenciais da memória virtual?", options: ["Limitar o tamanho dos programas.", "Apenas para sistemas operacionais antigos.", "Permitir a execução de programas maiores do que a RAM física disponível.", "Reduzir a velocidade do computador."], answer: "Permitir a execução de programas maiores do que a RAM física disponível.", image: "https://source.unsplash.com/random/400x300/?large,programs,execution" },
    { id: 31, topic: "Memória virtual", question: "Como a memória virtual ajuda na multiprogramação eficiente?", options: ["Ela impede a execução de múltiplos programas.", "Facilita a execução de vários programas complexos de forma suave.", "Faz com que os programas rodem um de cada vez.", "Não tem relação com multiprogramação."], answer: "Facilita a execução de vários programas complexos de forma suave.", image: "https://source.unsplash.com/random/400x300/?multiprogramming,efficiency,software" },
    { id: 32, topic: "Memória virtual", question: "Além de expandir o espaço de endereçamento, o que a memória virtual também oferece?", options: ["Apenas complexidade.", "Isolamento de memória robusto entre os processos.", "Diminuição da segurança.", "Maior custo de hardware."], answer: "Isolamento de memória robusto entre os processos.", image: "https://source.unsplash.com/random/400x300/?memory,isolation,security" },

    // --- Algoritmos de Substituição de Páginas: Otimizando o Desempenho ---
    { id: 33, topic: "Algoritmos de substituição de páginas", question: "Qual o propósito dos Algoritmos de Substituição de Páginas?", options: ["Determinar qual programa instalar.", "Decidir qual página de memória será removida da RAM quando uma nova precisar ser carregada.", "Apenas organizar arquivos no disco.", "Controlar o acesso à internet."], answer: "Decidir qual página de memória será removida da RAM quando uma nova precisar ser carregada.", image: "https://source.unsplash.com/random/400x300/?page,replacement,algorithm" },
    { id: 34, topic: "Algoritmos de substituição de páginas", question: "Qual algoritmo substitui a página que está na memória há mais tempo?", options: ["LRU (Least Recently Used).", "FIFO (First-In, First-Out).", "OPT (Ótimo).", "LFU (Least Frequently Used)."], answer: "FIFO (First-In, First-Out).", image: "https://source.unsplash.com/random/400x300/?FIFO,page,replacement,queue" },
    { id: 35, topic: "Algoritmos de substituição de páginas", question: "Qual algoritmo substitui a página menos utilizada recentemente?", options: ["FIFO (First-In, First-Out).", "LRU (Least Recently Used).", "OPT (Ótimo).", "Random (Aleatório)."], answer: "LRU (Least Recently Used).", image: "https://source.unsplash.com/random/400x300/?LRU,page,replacement,usage" },
    { id: 36, topic: "Algoritmos de substituição de páginas", question: "Qual algoritmo de substituição de páginas é ideal, mas impraticável de implementar na prática?", options: ["FIFO.", "LRU.", "OPT (Ótimo).", "Clock."], answer: "OPT (Ótimo).", image: "https://source.unsplash.com/random/400x300/?optimal,algorithm,prediction" },
    { id: 37, topic: "Algoritmos de substituição de páginas", question: "O que a 'anomalia de Belady' demonstra?", options: ["Que o LRU é sempre melhor que o FIFO.", "Que, para alguns padrões de acesso, aumentar o número de quadros de página pode, paradoxalmente, aumentar o número de faltas de página no FIFO.", "Que todos os algoritmos são igualmente eficientes.", "Que a memória virtual não funciona bem."], answer: "Que, para alguns padrões de acesso, aumentar o número de quadros de página pode, paradoxalmente, aumentar o número de faltas de página no FIFO.", image: "https://source.unsplash.com/random/400x300/?Belady,anomaly,page,replacement,faults" }
];

        let questions = JSON.parse(localStorage.getItem('quizQuestions')) || initialQuestions;
        let users = JSON.parse(localStorage.getItem('quizUsers')) || {
            'admin': { password: 'admin', isAdmin: true },
            'aluno': { password: '123', isAdmin: false }
        };
        let currentUser = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let quizStartTime;
        let quizTimer;
        let currentChart = null; // Para destruir o gráfico anterior
        let currentTopicChart = null; // Para o gráfico de tópico

        const loginPopup = document.getElementById('login-popup');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterButton = document.getElementById('show-register-button');
        const showLoginButton = document.getElementById('show-login-button');
        const formTitle = document.getElementById('form-title');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const registerPasswordConfirmInput = document.getElementById('register-password-confirm');
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const studentNameInput = document.getElementById('student-name-input');
        const startQuizButton = document.getElementById('start-quiz-button');
        const contentLinkButton = document.getElementById('content-link-button'); // Novo botão de link
        const quizDiv = document.getElementById('quiz');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const reportSection = document.getElementById('report-section');
        const reportStudentName = document.getElementById('report-student-name');
        const reportTimeTaken = document.getElementById('report-time-taken');
        const reportScore = document.getElementById('report-score');
        const reportTotalQuestions = document.getElementById('report-total-questions');
        const reportAverage = document.getElementById('report-average');
        const restartButtonReport = document.getElementById('restart-button-report');
        const exportPdfButton = document.getElementById('export-pdf-button');
        const exportSheetsButton = document.getElementById('export-sheets-button');
        const nextActivityButton = document.getElementById('next-activity-button');
        const detailedResults = document.getElementById('detailed-results');
        const adminPanel = document.getElementById('admin-panel');
        const closeAdminPanelButton = document.getElementById('close-admin-panel-button');
        const addQuestionButton = document.getElementById('add-question-button');
        const questionsList = document.getElementById('questions-list');
        const editQuestionModal = document.getElementById('edit-question-modal');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editQuestionId = document.getElementById('edit-question-id');
        const editQuestionTopic = document.getElementById('edit-question-topic'); // Mudou de área para tópico
        const editQuestionText = document.getElementById('edit-question-text');
        const editQuestionImage = document.getElementById('edit-question-image');
        const editOption1 = document.getElementById('edit-option-1');
        const editOption2 = document.getElementById('edit-option-2');
        const editOption3 = document.getElementById('edit-option-3');
        const editOption4 = document.getElementById('edit-option-4');
        const editCorrectAnswer = document.getElementById('edit-correct-answer');
        const saveQuestionButton = document.getElementById('save-question-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const fetchImageButton = document.getElementById('fetch-image-button');

        // --- Funções de Autenticação ---
        function saveUsers() {
            localStorage.setItem('quizUsers', JSON.stringify(users));
        }

        function saveQuestions() {
            localStorage.setItem('quizQuestions', JSON.stringify(questions));
        }

        function showLoginForm() {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            formTitle.textContent = 'Acessar Quiz';
        }

        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            formTitle.textContent = 'Registrar Nova Conta';
        }

        loginButton.addEventListener('click', () => {
            const username = loginUsernameInput.value;
            const password = loginPasswordInput.value;

            if (users[username] && users[username].password === password) {
                currentUser = username;
                studentNameInput.value = username;
                loginPopup.style.display = 'none';
                mainContentWrapper.style.display = 'block';
                contentLinkButton.style.display = 'inline-block'; // Mostra o botão de conteúdo
                if (users[username].isAdmin) {
                    const adminButton = document.createElement('button');
                    adminButton.textContent = 'Acessar Painel Admin';
                    adminButton.className = 'action-button';
                    adminButton.id = 'admin-access-button';
                    adminButton.style.marginTop = '20px';
                    adminButton.addEventListener('click', showAdminPanel);
                    document.getElementById('start-screen').insertBefore(adminButton, startQuizButton); // Adiciona antes do botão de iniciar quiz
                }
                alert('Login bem-sucedido!');
            } else {
                alert('Usuário ou senha inválidos.');
            }
        });

        registerButton.addEventListener('click', () => {
            const username = registerUsernameInput.value;
            const password = registerPasswordInput.value;
            const confirmPassword = registerPasswordConfirmInput.value;

            if (username.length < 3) {
                alert('O nome de usuário deve ter pelo menos 3 caracteres.');
                return;
            }
            if (password.length < 3) {
                alert('A senha deve ter pelo menos 3 caracteres.');
                return;
            }
            if (password !== confirmPassword) {
                alert('As senhas não coincidem.');
                return;
            }
            if (users[username]) {
                alert('Nome de usuário já existe. Escolha outro.');
                return;
            }

            users[username] = { password: password, isAdmin: false };
            saveUsers();
            alert('Registro bem-sucedido! Faça login para continuar.');
            showLoginForm();
            registerUsernameInput.value = '';
            registerPasswordInput.value = '';
            registerPasswordConfirmInput.value = '';
        });

        showRegisterButton.addEventListener('click', (e) => {
            e.preventDefault();
            showRegisterForm();
        });

        showLoginButton.addEventListener('click', (e) => {
            e.preventDefault();
            showLoginForm();
        });

        // --- Funções do Quiz ---
        function startQuiz() {
            currentQuestionIndex = 0;
            userAnswers = Array(questions.length).fill(null);
            quizStartTime = Date.now();
            quizDiv.style.display = 'block';
            document.getElementById('start-screen').style.display = 'none';
            reportSection.style.display = 'none'; // Esconde o relatório se visível
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex < 0) {
                currentQuestionIndex = 0;
            } else if (currentQuestionIndex >= questions.length) {
                currentQuestionIndex = questions.length - 1;
            }

            const question = questions[currentQuestionIndex];
            questionText.innerHTML = `
                ${question.image ? `<img src="${question.image}" alt="Imagem da Pergunta" />` : ''}
                ${currentQuestionIndex + 1}. ${question.question}
                <span class="attempt-count">(Tentativas: ${userAnswers[currentQuestionIndex] ? userAnswers[currentQuestionIndex].attempts : 0})</span>
            `;
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'option-button';
                button.onclick = () => selectOption(option);
                optionsContainer.appendChild(button);

                // Se o usuário já respondeu, marque a opção selecionada
                if (userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].answer === option) {
                    button.classList.add('selected');
                }
            });

            prevButton.disabled = currentQuestionIndex === 0;
            nextButton.textContent = currentQuestionIndex === questions.length - 1 ? 'Finalizar Quiz' : 'Próxima';
        }

        function selectOption(selectedOption) {
            // Incrementa as tentativas, se não houver resposta prévia ou se for a primeira vez
            const currentAttempts = userAnswers[currentQuestionIndex] ? userAnswers[currentQuestionIndex].attempts + 1 : 1;

            userAnswers[currentQuestionIndex] = {
                answer: selectedOption,
                isCorrect: selectedOption === questions[currentQuestionIndex].answer,
                attempts: currentAttempts // Armazena o número de tentativas
            };

            // Remove a seleção de todos os botões e adiciona ao selecionado
            Array.from(optionsContainer.children).forEach(button => {
                button.classList.remove('selected');
                if (button.textContent === selectedOption) {
                    button.classList.add('selected');
                }
            });

            // Atualiza o contador de tentativas na tela
            questionText.querySelector('.attempt-count').textContent = `(Tentativas: ${currentAttempts})`;
        }

        nextButton.addEventListener('click', () => {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                // Finalizar Quiz
                endQuiz();
            }
        });

        prevButton.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        });

        function endQuiz() {
            const quizEndTime = Date.now();
            const timeTakenSeconds = Math.floor((quizEndTime - quizStartTime) / 1000);
            let score = 0;
            let correctCountByTopic = {}; // Mudou para topic
            let totalCountByTopic = {}; // Mudou para topic

            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                if (userAnswer && userAnswer.isCorrect) {
                    score++;
                }

                // Inicializar contadores por tópico
                if (!totalCountByTopic[q.topic]) { // Acessa q.topic
                    totalCountByTopic[q.topic] = 0;
                    correctCountByTopic[q.topic] = 0;
                }
                totalCountByTopic[q.topic]++;
                if (userAnswer && userAnswer.isCorrect) {
                    correctCountByTopic[q.topic]++;
                }
            });

            const average = questions.length > 0 ? (score / questions.length * 100).toFixed(2) : 0;

            reportStudentName.textContent = studentNameInput.value;
            reportTimeTaken.textContent = timeTakenSeconds;
            reportScore.textContent = score;
            reportTotalQuestions.textContent = questions.length;
            reportAverage.textContent = average;

            renderCharts(score, questions.length, correctCountByTopic, totalCountByTopic); // Passa os dados de tópico
            renderDetailedResults();

            quizDiv.style.display = 'none';
            reportSection.style.display = 'block';
        }

        function renderCharts(score, totalQuestions, correctCountByTopic, totalCountByTopic) { // Recebe dados de tópico
            // Destrói o gráfico anterior se existir
            if (currentChart) {
                currentChart.destroy();
            }
            if (currentTopicChart) { // Usa currentTopicChart
                currentTopicChart.destroy();
            }

            // Gráfico Geral de Acertos e Erros
            const ctx = document.getElementById('report-canvas').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Acertos', 'Erros'],
                    datasets: [{
                        data: [score, totalQuestions - score],
                        backgroundColor: ['#4CAF50', '#F44336'],
                        borderColor: ['#ffffff', '#ffffff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Acertos vs. Erros',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(2) + '%';
                                    return `${label}: ${value} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico por Tópico de Conhecimento
            const topicLabels = Object.keys(totalCountByTopic); // Usa topic
            const topicPercentages = topicLabels.map(topic => {
                const correct = correctCountByTopic[topic];
                const total = totalCountByTopic[topic];
                return total > 0 ? ((correct / total) * 100).toFixed(2) : 0;
            });

            const topicCtx = document.getElementById('area-report-canvas').getContext('2d'); // Renomeado para 'topic-report-canvas' para clareza
            currentTopicChart = new Chart(topicCtx, { // Usa currentTopicChart
                type: 'bar',
                data: {
                    labels: topicLabels,
                    datasets: [{
                        label: '% de Acerto por Tópico',
                        data: topicPercentages,
                        backgroundColor: '#4285f4', // Azul
                        borderColor: '#1a237e',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Desempenho por Tópico de Conhecimento',
                            font: {
                                size: 18
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentagem de Acerto (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tópico de Conhecimento'
                            }
                        }
                    }
                }
            });
        }

        function renderDetailedResults() {
            detailedResults.innerHTML = '<h3>Resultados Detalhados:</h3>';
            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                const questionResultDiv = document.createElement('div');
                questionResultDiv.className = 'question-result';

                let statusText = '';
                let statusClass = '';
                let userAnswerText = 'Não respondida';
                let attemptsText = '';

                if (userAnswer) {
                    statusText = userAnswer.isCorrect ? 'Correta' : 'Incorreta';
                    statusClass = userAnswer.isCorrect ? 'correct-q' : 'wrong-q';
                    userAnswerText = `Sua resposta: <span class="user-answer">${userAnswer.answer}</span>`;
                    attemptsText = `<span class="attempt-count-report">Tentativas: ${userAnswer.attempts}</span>`;
                } else {
                    statusClass = 'not-answered-q';
                }

                questionResultDiv.classList.add(statusClass);

                questionResultDiv.innerHTML = `
                    <p class="q-text"><strong>${index + 1}. ${q.question}</strong></p>
                    <p>${userAnswerText} ${attemptsText}</p>
                    <p>Resposta correta: <span class="correct-answer">${q.answer}</span></p>
                    <p>Status: <span class="${userAnswer && userAnswer.isCorrect ? 'status-correct' : 'status-incorrect'}">${statusText}</span></p>
                `;
                detailedResults.appendChild(questionResultDiv);
            });
        }


        startQuizButton.addEventListener('click', startQuiz);
        restartButtonReport.addEventListener('click', () => {
            reportSection.style.display = 'none';
            document.getElementById('start-screen').style.display = 'block';
        });

        // --- Funções de Exportação ---
        exportPdfButton.addEventListener('click', exportQuizReportToPdf);

        async function exportQuizReportToPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont('helvetica');
            doc.setFontSize(22);
            doc.text("Relatório do Quiz de Sistemas Operacionais", 105, 20, null, null, "center");

            doc.setFontSize(12);
            doc.text(`Aluno(a): ${reportStudentName.textContent}`, 15, 35);
            doc.text(`Tempo Total: ${reportTimeTaken.textContent} segundos`, 15, 42);
            doc.text(`Pontuação: ${reportScore.textContent} / ${reportTotalQuestions.textContent} (${reportAverage.textContent}%)`, 15, 49);

            // Adicionar gráficos como imagens
            const canvas = document.getElementById('report-canvas');
            const topicCanvas = document.getElementById('area-report-canvas'); // Referência correta

            const addChartToPdf = async (chartCanvas, x, y, width, height) => {
                const imgData = chartCanvas.toDataURL('image/png');
                doc.addImage(imgData, 'PNG', x, y, width, height);
            };

            // Ajustar posições dos gráficos para caber na página
            const chartWidth = 90;
            const chartHeight = 70;
            await addChartToPdf(canvas, 15, 60, chartWidth, chartHeight);
            await addChartToPdf(topicCanvas, 105, 60, chartWidth, chartHeight); // Usa topicCanvas

            doc.setFontSize(16);
            doc.text("Resultados Detalhados:", 15, 145);

            // Preparar resultados detalhados para PDF com escrita simples e concisa
            detailedResults.classList.add('pdf-mode'); // Adiciona classe para otimização CSS
            const originalDetailedResultsHtml = detailedResults.innerHTML; // Salva o HTML original

            // Renderiza os resultados detalhados de forma mais compacta para PDF
            let pdfDetailedResultsHtml = '<ul>';
            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                const statusText = userAnswer && userAnswer.isCorrect ? 'Correta' : 'Incorreta';
                const statusColor = userAnswer && userAnswer.isCorrect ? 'color: #4CAF50;' : 'color: #F44336;';
                const userAnswerContent = userAnswer ? `Sua resp: <span class="user-answer-pdf">${userAnswer.answer}</span>` : 'Não respondida';
                const attemptsContent = userAnswer ? ` (Tentativas: ${userAnswer.attempts})` : '';

                // Formato mais conciso em uma única linha por questão, se possível
                pdfDetailedResultsHtml += `
                    <li>
                        <span class="q-num">${index + 1}.</span> <span class="q-text">${q.question}</span> |
                        ${userAnswerContent}${attemptsContent} |
                        Resp. correta: <span class="correct-answer-pdf">${q.answer}</span> |
                        Status: <span style="${statusColor}">${statusText}</span>
                    </li>
                `;
            });
            pdfDetailedResultsHtml += '</ul>';
            detailedResults.innerHTML = pdfDetailedResultsHtml; // Temporariamente altera o HTML para renderização no PDF

            // Capturar o HTML renderizado dos resultados detalhados
            html2canvas(detailedResults, {
                scale: 2, // Melhorar a qualidade do texto
                useCORS: true // Essencial para imagens externas
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190; // Largura A4 - margens
                const pageHeight = doc.internal.pageSize.height;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 155; // Posição inicial após os gráficos

                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight - position;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 10; // 10mm de margem no topo
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save('Relatorio_Quiz_Sistemas_Operacionais.pdf');

                // Restaurar o HTML original e remover a classe
                detailedResults.innerHTML = originalDetailedResultsHtml;
                detailedResults.classList.remove('pdf-mode');
            }).catch(error => {
                console.error("Erro ao gerar PDF com html2canvas:", error);
                alert("Ocorreu um erro ao gerar o PDF. Verifique o console para mais detalhes.");
                // Em caso de erro, restaurar o HTML original
                detailedResults.innerHTML = originalDetailedResultsHtml;
                detailedResults.classList.remove('pdf-mode');
            });
        }

        exportSheetsButton.addEventListener('click', () => {
            alert('Funcionalidade "Exportar para Planilhas Google" ainda não implementada.');
        });

        nextActivityButton.addEventListener('click', () => {
            alert('Funcionalidade "Próxima Atividade" ainda não implementada.');
        });

        // --- Funções do Painel Administrativo ---
        function showAdminPanel() {
            if (!currentUser || !users[currentUser].isAdmin) {
                alert('Acesso negado. Apenas administradores podem acessar esta seção.');
                return;
            }
            mainContentWrapper.style.display = 'none';
            adminPanel.style.display = 'flex';
            renderQuestionsList();
        }

        closeAdminPanelButton.addEventListener('click', () => {
            adminPanel.style.display = 'none';
            mainContentWrapper.style.display = 'block';
        });

        function renderQuestionsList() {
            questionsList.innerHTML = '';
            questions.forEach(q => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>ID: ${q.id} | Tópico: ${q.topic}</strong>
                    <span><strong>Pergunta:</strong> ${q.question}</span>
                    <span><strong>Opções:</strong> ${q.options.join('; ')}</span>
                    <span><strong>Resposta Correta:</strong> ${q.answer}</span>
                    ${q.image ? `<span><strong>URL Imagem:</strong> <a href="${q.image}" target="_blank">Ver Imagem</a></span>` : ''}
                    <div class="actions">
                        <button class="edit-btn" data-id="${q.id}">Editar</button>
                        <button class="delete-btn" data-id="${q.id}">Excluir</button>
                    </div>
                `;
                questionsList.appendChild(li);
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const questionId = parseInt(e.target.dataset.id);
                    editQuestion(questionId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const questionId = parseInt(e.target.dataset.id);
                    deleteQuestion(questionId);
                });
            });
        }

        addQuestionButton.addEventListener('click', () => {
            editQuestion(-1); // -1 indica nova pergunta
        });

        function editQuestion(id) {
            editQuestionModal.style.display = 'flex';
            let questionToEdit = {
                id: null,
                topic: 'Processos', // Padrão para o primeiro tópico
                question: '',
                options: ['', '', '', ''],
                answer: '',
                image: ''
            };

            if (id !== -1) {
                questionToEdit = questions.find(q => q.id === id);
                editModalTitle.textContent = 'Editar Pergunta';
            } else {
                editModalTitle.textContent = 'Adicionar Nova Pergunta';
            }

            editQuestionId.value = questionToEdit.id;
            editQuestionTopic.value = questionToEdit.topic; // Define o tópico
            editQuestionText.value = questionToEdit.question;
            editQuestionImage.value = questionToEdit.image;
            editOption1.value = questionToEdit.options[0] || '';
            editOption2.value = questionToEdit.options[1] || '';
            editOption3.value = questionToEdit.options[2] || '';
            editOption4.value = questionToEdit.options[3] || '';

            // Popula as opções do select de tópico
            const topics = [
                "Processos",
                "Threads",
                "Comunicação interprocessos (IPC)",
                "Escalonamento",
                "Uso direto de memória",
                "Abstração de memória: espaço de endereçamento",
                "Memória virtual",
                "Algoritmos de substituição de páginas"
            ];
            editQuestionTopic.innerHTML = '';
            topics.forEach(t => {
                const optionElement = document.createElement('option');
                optionElement.value = t;
                optionElement.textContent = t;
                editQuestionTopic.appendChild(optionElement);
            });
            editQuestionTopic.value = questionToEdit.topic; // Garante que o tópico correto seja selecionado

            updateCorrectAnswerOptions();
            editCorrectAnswer.value = questionToEdit.answer;
        }

        // Atualiza as opções do select de resposta correta
        function updateCorrectAnswerOptions() {
            editCorrectAnswer.innerHTML = '';
            const options = [editOption1.value, editOption2.value, editOption3.value, editOption4.value].filter(opt => opt.trim() !== '');
            options.forEach(opt => {
                const optionElement = document.createElement('option');
                optionElement.value = opt;
                optionElement.textContent = opt;
                editCorrectAnswer.appendChild(optionElement);
            });
        }

        // Listener para atualizar as opções de resposta correta enquanto o usuário digita
        [editOption1, editOption2, editOption3, editOption4].forEach(input => {
            input.addEventListener('input', updateCorrectAnswerOptions);
        });

        saveQuestionButton.addEventListener('click', () => {
            const id = parseInt(editQuestionId.value);
            const topic = editQuestionTopic.value; // Pega o tópico
            const questionTextValue = editQuestionText.value.trim();
            const imageURL = editQuestionImage.value.trim();
            const options = [
                editOption1.value.trim(),
                editOption2.value.trim(),
                editOption3.value.trim(),
                editOption4.value.trim()
            ].filter(opt => opt !== ''); // Filtra opções vazias

            const correctAnswer = editCorrectAnswer.value.trim();

            if (!questionTextValue || options.length < 2 || !correctAnswer) {
                alert('Por favor, preencha a pergunta, pelo menos duas opções e selecione a resposta correta.');
                return;
            }

            // Garante que a resposta correta seja uma das opções válidas
            if (!options.includes(correctAnswer)) {
                alert('A resposta correta deve ser uma das opções fornecidas.');
                return;
            }

            if (id === -1) { // Nova pergunta
                const newId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1;
                questions.push({
                    id: newId,
                    topic: topic,
                    question: questionTextValue,
                    options: options,
                    answer: correctAnswer,
                    image: imageURL
                });
            } else { // Editar pergunta existente
                const index = questions.findIndex(q => q.id === id);
                if (index !== -1) {
                    questions[index] = {
                        id: id,
                        topic: topic,
                        question: questionTextValue,
                        options: options,
                        answer: correctAnswer,
                        image: imageURL
                    };
                }
            }
            saveQuestions();
            renderQuestionsList();
            editQuestionModal.style.display = 'none';
        });

        cancelEditButton.addEventListener('click', () => {
            editQuestionModal.style.display = 'none';
        });

        function deleteQuestion(id) {
            if (confirm(`Tem certeza que deseja excluir a pergunta ID ${id}?`)) {
                questions = questions.filter(q => q.id !== id);
                saveQuestions();
                renderQuestionsList();
                alert('Pergunta excluída com sucesso!');
            }
        }

        // --- Funcionalidade de Buscar Imagem ---
        fetchImageButton.addEventListener('click', async () => {
            const query = editQuestionText.value.trim();
            if (query) {
                try {
                    const imageUrl = await simulateImageSearch(query);
                    if (imageUrl) {
                        editQuestionImage.value = imageUrl;
                        alert('Imagem encontrada e URL preenchida!');
                    } else {
                        alert('Nenhuma imagem relevante encontrada para esta pergunta.');
                    }
                } catch (error) {
                    console.error("Erro ao buscar imagem:", error);
                    alert('Erro ao buscar imagem. Tente novamente mais tarde.');
                }
            } else {
                alert('Por favor, digite o texto da pergunta para buscar uma imagem.');
            }
        });

        async function simulateImageSearch(query) {
            const keywords = query.toLowerCase().split(' ').filter(word => word.length > 2).slice(0, 5); // Pega até 5 palavras-chave
            const baseQuery = keywords.length > 0 ? keywords.join(',') : 'operating,system,computer'; // Fallback se query for muito curta

            // Adiciona termos genéricos para garantir alguma imagem, mesmo que a pergunta seja muito específica
            const genericTerms = ['technology', 'programming', 'abstract', 'data'];
            const finalQuery = `${baseQuery},${genericTerms[Math.floor(Math.random() * genericTerms.length)]}`;

            return `https://source.unsplash.com/random/400x300/?${finalQuery}`;
        }
    </script>
</body>
</html>
