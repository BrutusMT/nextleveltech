<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz de Informática</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* SEU CÓDIGO CSS VAI AQUI */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #0a192f, #1e3a8a); /* Gradiente de azul escuro para claro */
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box; /* Garante que padding não cause overflow */
        }

        .quiz-container {
            background-color: rgba(255, 255, 255, 0.1); /* Fundo translúcido para melhor legibilidade */
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 95%;
            max-width: 700px;
            text-align: center;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Seção de entrada de nome */
        #start-screen {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        #start-screen input[type="text"] {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 80%;
            max-width: 300px;
            font-size: 1.1em;
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
        }
        #start-screen button {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #start-screen button:hover {
            background-color: #2e7d32;
            transform: translateY(-2px);
        }


        .question {
            margin-bottom: 30px;
            font-size: 1.4em;
            color: #e0e0e0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .question .attempt-count {
            font-size: 0.8em;
            color: #ccc;
            margin-left: 10px;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .option-button {
            background-color: #3f51b5; /* Azul mais vibrante */
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .option-button:hover {
            background-color: #283593; /* Azul mais escuro ao passar o mouse */
            transform: translateY(-2px);
        }

         .option-button.selected {
            border: 2px solid #ffd740; /* Destaque amarelo para a opção selecionada */
            background-color: #283593; /* Ajusta o fundo da opção selecionada */
        }
         /* Removido feedback de cores imediato */
         /* .option-button.correct {
            background-color: #4CAF50;
            border: 2px solid #2e7d32;
        }
        .option-button.incorrect {
            background-color: #F44336;
            border: 2px solid #c62828;
        } */

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .navigation-buttons button {
            background-color: #546e7a; /* Cinza azulado */
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .navigation-buttons button:hover {
            background-color: #37474f; /* Cinza mais escuro ao passar o mouse */
            transform: translateY(-2px);
        }

        .navigation-buttons button:disabled {
            background-color: #90a4ae;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .result {
            margin-top: 30px;
            font-size: 1.8em;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            /* Removido feedback imediato */
            display: none;
        }

        #restart-button {
            background-color: #28a745;
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            border: none;
            transition: background-color 0.3s ease;
        }

        #restart-button:hover {
            background-color: #218838;
        }

        /* --- Seção de Relatório --- */
        #report-section {
            display: none; /* Esconde por padrão */
            text-align: left;
            padding: 20px;
            background-color: #e0f2f7; /* Fundo azul clarinho para o relatório */
            color: #333; /* Cor de texto mais escura para contraste */
            border-radius: 15px; /* Bordas arredondadas para o relatório */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* Sombra para destacar */
        }

        #report-section h2 {
            text-align: center;
            color: #1e3a8a; /* Azul escuro para o título */
            font-size: 2.2em;
            margin-bottom: 25px;
        }

        #report-section h2,
        #report-summary p,
        #detailed-results h3,
        .question-result .q-text,
        .question-result p {
            /* Removidas propriedades de text-stroke e text-shadow */
        }
        /* Ajusta a cor do texto para que o contorno apareça */
        #report-section h2 { color: #1e3a8a; } /* Mantém a cor original do título */
        #report-summary p { color: #333; }
        #report-summary span { color: #00008b; /* Azul mais escuro para destaque */ }
        #detailed-results h3 { color: #1e3a8a; }
        .question-result .q-text { color: #333; }
        .question-result .user-answer { color: #0056b3; } /* Azul médio */
        .question-result .correct-answer { color: #28a745; } /* Verde para corretas */
        .question-result p { color: #444; }


        #report-summary {
            background-color: rgba(255, 255, 255, 0.6); /* Fundo um pouco mais claro para o resumo */
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #report-summary p {
            margin: 10px 0;
            font-size: 1.2em;
            color: #333; /* Cor de texto padrão para o resumo */
        }

        #report-summary span {
            font-weight: bold;
            color: #00008b; /* Azul marinho para destaque */
        }

        #chart-container {
            width: 80%; /* Ajuste o tamanho do gráfico */
            max-width: 400px;
            margin: 25px auto;
            background-color: #ffffff; /* Fundo branco para o canvas */
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        #report-canvas {
            background-color: transparent !important; /* Garante que o fundo do canvas é transparente */
        }

        #area-chart-container {
            width: 90%; /* Ajuste o tamanho do gráfico */
            max-width: 500px;
            margin: 25px auto;
            background-color: #ffffff; /* Fundo branco para o canvas */
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }


        #detailed-results {
            margin-top: 25px;
        }

        .question-result {
            background-color: rgba(255, 255, 255, 0.6); /* Fundo um pouco mais claro para cada resultado */
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 1.1em;
            color: #333; /* Cor de texto padrão */
        }

        .question-result p {
            margin: 5px 0;
        }

        .question-result .q-text {
            font-weight: bold;
            color: #1e3a8a; /* Azul escuro para o texto da pergunta */
            margin-bottom: 10px;
        }

        .question-result .user-answer {
            color: #0056b3; /* Azul médio */
        }

        .question-result .correct-answer {
            color: #28a745; /* Verde para corretas */
        }
        .question-result .attempt-count-report {
            font-size: 0.9em;
            color: #666;
            margin-left: 5px;
        }

        .question-result.correct-q {
            border-left: 5px solid #4caf50;
        }

        .question-result.wrong-q {
            border-left: 5px solid #f44336;
        }

        #report-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        #report-buttons button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #report-buttons button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        #report-buttons button:first-child { /* Reiniciar Quiz */
            background-color: #28a745;
        }
        #report-buttons button:first-child:hover {
            background-color: #218838;
        }

        #report-buttons button:last-child { /* Exportar PDF */
            background-color: #dc3545; /* Vermelho para exportar/perigoso */
        }
        #report-buttons button:last-child:hover {
            background-color: #c82333;
        }
        /* Cor do novo botão "Exportar para Planilhas" */
        #report-buttons #export-sheets-button {
            background-color: #1a73e8; /* Azul do Google */
        }
        #report-buttons #export-sheets-button:hover {
            background-color: #1558b0;
        }


        /* --- Estilos do Pop-up de Login e Registro --- */
        .login-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-popup-content {
            background-color: #0a192f; /* Azul escuro do gradiente */
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            animation: fadeInScale 0.3s ease-out forwards;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.85);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .login-popup-content h2 {
            color: #ffffff;
            margin-bottom: 25px;
            font-size: 2em;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .login-popup-content input[type="text"],
        .login-popup-content input[type="password"] {
            width: calc(100% - 24px); /* Ajusta pelo padding */
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #3f51b5; /* Borda azul */
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }

        .login-popup-content input[type="text"]:focus,
        .login-popup-content input[type="password"]:focus {
            border-color: #ffd740; /* Destaque amarelo no foco */
            outline: none;
        }

        .login-popup-content button {
            background-color: #007bff; /* Azul vibrante */
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, transform 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            margin: 5px; /* Espaço entre botões */
        }

        .login-popup-content button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .login-popup-content .switch-button {
            background-color: #6c757d; /* Cinza para alternar formulário */
        }
        .login-popup-content .switch-button:hover {
            background-color: #5a6268;
        }


        /* Conteúdo principal do quiz escondido até o login */
        #main-content-wrapper {
            display: none; /* Esconde todo o conteúdo do quiz por padrão */
            width: 100%;
            max-width: 700px;
            padding: 20px;
        }

        /* --- Estilos do Painel de Controle Admin --- */
        .admin-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Escondido por padrão */
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Acima do pop-up de login */
        }

        .admin-panel-content {
            background-color: #0a192f;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.7);
            width: 95%;
            max-width: 800px;
            max-height: 90vh; /* Limita a altura para rolagem */
            overflow-y: auto; /* Adiciona rolagem se o conteúdo for muito grande */
            text-align: center;
            color: #ffffff;
        }

        .admin-panel-content h2 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 2em;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .admin-panel-content button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin: 5px;
        }

        .admin-panel-content button:hover {
            background-color: #0056b3;
        }

        .admin-panel-content .add-button {
            background-color: #28a745; /* Verde para adicionar */
            margin-bottom: 20px;
        }
        .admin-panel-content .add-button:hover {
            background-color: #218838;
        }
         .admin-panel-content .close-button {
            background-color: #dc3545; /* Vermelho para fechar */
            margin-top: 20px;
        }
        .admin-panel-content .close-button:hover {
            background-color: #c82333;
        }

        #questions-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        #questions-list li {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            flex-direction: column; /* Para empilhar o texto e os botões */
            align-items: flex-start; /* Alinha o texto à esquerda */
            text-align: left; /* Garante que o texto esteja alinhado à esquerda */
            font-size: 1.1em;
        }

        #questions-list li strong {
            margin-bottom: 5px;
            color: #ffd740; /* Amarelo para a pergunta */
        }
        #questions-list li span {
            font-size: 0.9em;
            color: #cccccc;
            margin-bottom: 5px;
        }

        #questions-list .actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-self: flex-end; /* Alinha os botões à direita */
        }

        #questions-list .actions .edit-btn {
            background-color: #ffc107; /* Amarelo para editar */
            color: #333;
        }
        #questions-list .actions .edit-btn:hover {
            background-color: #e0a800;
        }
        #questions-list .actions .delete-btn {
            background-color: #dc3545; /* Vermelho para deletar */
        }
        #questions-list .actions .delete-btn:hover {
            background-color: #c82333;
        }

        /* --- Estilos do Modal de Edição de Pergunta --- */
        .edit-question-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none; /* Escondido por padrão */
            justify-content: center;
            align-items: center;
            z-index: 3000; /* Acima do painel admin */
        }

        .edit-question-modal-content {
            background-color: #1e3a8a; /* Azul mais escuro do gradiente do body */
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            width: 90%;
            max-width: 600px;
            color: #ffffff;
            text-align: left;
        }

        .edit-question-modal-content h3 {
            color: #ffffff;
            margin-bottom: 20px;
            text-align: center;
        }

        .edit-question-modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0e0e0;
        }

        .edit-question-modal-content input[type="text"],
        .edit-question-modal-content textarea,
        .edit-question-modal-content select {
            width: calc(100% - 24px); /* Ajusta pelo padding */
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #3f51b5;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1em;
        }

        .edit-question-modal-content textarea {
            resize: vertical;
            min-height: 80px;
        }

        .edit-question-modal-content .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .edit-question-modal-content .modal-buttons button {
            padding: 10px 25px;
            font-size: 1.1em;
            border-radius: 8px;
        }
        .edit-question-modal-content .modal-buttons .save-btn {
            background-color: #28a745;
        }
        .edit-question-modal-content .modal-buttons .save-btn:hover {
            background-color: #218838;
        }
        .edit-question-modal-content .modal-buttons .cancel-btn {
            background-color: #6c757d;
        }
        .edit-question-modal-content .modal-buttons .cancel-btn:hover {
            background-color: #5a6268;
        }

    </style>
</head>
<body>
    <div class="login-popup-overlay" id="login-popup">
        <div class="login-popup-content">
            <h2 id="form-title">Acessar Quiz</h2>
            <div id="login-form">
                <input type="text" id="login-username" placeholder="Usuário">
                <input type="password" id="login-password" placeholder="Senha">
                <button id="login-button">Entrar</button>
                <button id="show-register-button" class="switch-button">Registrar</button>
            </div>

            <div id="register-form" style="display:none;">
                <input type="text" id="register-username" placeholder="Novo Usuário">
                <input type="password" id="register-password" placeholder="Nova Senha">
                <input type="password" id="register-password-confirm" placeholder="Confirme a Senha">
                <button id="register-button">Criar Conta</button>
                <button id="show-login-button" class="switch-button">Voltar ao Login</button>
            </div>
        </div>
    </div>

    <div class="admin-panel-overlay" id="admin-panel">
        <div class="admin-panel-content">
            <h2>Painel de Controle do Quiz</h2>
            <button id="add-question-button" class="add-button">Adicionar Nova Pergunta</button>
            <ul id="questions-list">
                </ul>
            <button id="close-admin-panel-button" class="close-button">Fechar Painel</button>
        </div>
    </div>

    <div class="edit-question-modal-overlay" id="edit-question-modal">
        <div class="edit-question-modal-content">
            <h3 id="edit-modal-title">Editar Pergunta</h3>
            <input type="hidden" id="edit-question-id">

            <label for="edit-question-area">Área:</label>
            <select id="edit-question-area">
                <option value="Hardware">Hardware</option>
                <option value="Software & Sistemas Operacionais">Software & Sistemas Operacionais</option>
                <option value="Redes & Internet">Redes & Internet</option>
            </select>

            <label for="edit-question-text">Pergunta:</label>
            <textarea id="edit-question-text"></textarea>

            <label for="edit-option-1">Opção 1:</label>
            <input type="text" id="edit-option-1">
            <label for="edit-option-2">Opção 2:</label>
            <input type="text" id="edit-option-2">
            <label for="edit-option-3">Opção 3:</label>
            <input type="text" id="edit-option-3">
            <label for="edit-option-4">Opção 4:</label>
            <input type="text" id="edit-option-4">

            <label for="edit-correct-answer">Resposta Correta:</label>
            <select id="edit-correct-answer">
                </select>

            <div class="modal-buttons">
                <button id="save-question-button" class="save-btn">Salvar</button>
                <button id="cancel-edit-button" class="cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>


    <div id="main-content-wrapper" class="quiz-container">
        <h1>Quiz de Conhecimentos em Informática</h1>

        <div id="start-screen">
            <input type="text" id="student-name-input" placeholder="Digite seu nome">
            <button id="start-quiz-button">Iniciar Quiz</button>
        </div>

        <div id="quiz" style="display:none;">
            <div class="question" id="question-text"></div>
            <div class="options-container" id="options-container"></div>
            <div class="navigation-buttons">
                <button id="prev-button" disabled>Anterior</button>
                <button id="next-button">Próxima</button>
            </div>
            <div class="result" id="result"></div>
        </div>

        <div id="report-section">
            <h2>Relatório do Quiz</h2>
            <div id="report-summary">
                <p>Nome do Aluno: <span id="report-student-name"></span></p>
                <p>Tempo Gasto: <span id="report-time-taken"></span> segundos</p>
                <p>Pontuação Total: <span id="report-score"></span> / <span id="report-total-questions"></span></p>
                <p>Aproveitamento Geral: <span id="report-average"></span>%</p>
            </div>

            <div id="chart-container">
                <canvas id="report-canvas"></canvas>
            </div>

            <div id="area-chart-container">
                <canvas id="area-report-canvas"></canvas>
            </div>

            <div id="detailed-results">
                <h3>Respostas Detalhadas:</h3>
                </div>

            <div id="report-buttons">
                <button id="restart-button-report">Reiniciar Quiz</button>
                <button id="export-pdf-button">Exportar PDF</button>
                <button id="export-sheets-button">Exportar para Planilhas</button> </div>
        </div>
    </div>

    <script>
        // Perguntas iniciais. Elas serão carregadas do localStorage se existirem.
        const initialQuestions = [
            // HARDWARE (17 Questões)
            { id: 1, area: "Hardware", question: "Qual o acrônimo para 'Unidade Central de Processamento'?", options: ["GPU", "RAM", "CPU", "SSD"], answer: "CPU" },
            { id: 2, area: "Hardware", question: "Qual componente armazena dados temporariamente para acesso rápido pela CPU?", options: ["HD", "SSD", "RAM", "ROM"], answer: "RAM" },
            { id: 3, area: "Hardware", question: "Um disco rígido (HD) é um tipo de memória...", options: ["volátil", "cache", "primária", "secundária"], answer: "secundária" },
            { id: 4, area: "Hardware", question: "Qual dispositivo de saída é usado para exibir imagens?", options: ["Teclado", "Impressora", "Monitor", "Mouse"], answer: "Monitor" },
            { id: 5, area: "Hardware", question: "Qual porta é comumente usada para conectar periféricos como pen drives e impressoras?", options: ["HDMI", "VGA", "USB", "Ethernet"], answer: "USB" },
            { id: 6, area: "Hardware", question: "A BIOS é um firmware armazenado em qual tipo de memória?", options: ["RAM", "ROM", "SSD", "HD"], answer: "ROM" },
            { id: 7, area: "Hardware", question: "Qual componente é responsável por gerar as imagens em um monitor?", options: ["CPU", "GPU", "RAM", "Placa Mãe"], answer: "GPU" },
            { id: 8, area: "Hardware", question: "O que significa SSD?", options: ["Solid State Drive", "Super Speed Disk", "Software Storage Device", "System Service Drive"], answer: "Solid State Drive" },
            { id: 9, area: "Hardware", question: "Qual o nome da principal placa de circuito do computador?", options: ["Placa de Vídeo", "Placa de Rede", "Placa Mãe", "Placa de Som"], answer: "Placa Mãe" },
            { id: 10, area: "Hardware", question: "Qual dispositivo é usado para digitalizar documentos e imagens?", options: ["Impressora", "Plotter", "Scanner", "Projetor"], answer: "Scanner" },
            { id: 11, area: "Hardware", question: "Um microfone é um dispositivo de...", options: ["saída", "entrada", "processamento", "armazenamento"], answer: "entrada" },
            { id: 12, area: "Hardware", question: "Qual tipo de impressora usa toner para imprimir?", options: ["Jato de Tinta", "Matricial", "Laser", "Térmica"], answer: "Laser" },
            { id: 13, area: "Hardware", question: "O que é um 'cooler' no computador?", options: ["Dispositivo de som", "Ventoinha para resfriamento", "Unidade de medida de temperatura", "Tipo de memória"], answer: "Ventoinha para resfriamento" },
            { id: 14, area: "Hardware", question: "Qual componente fornece energia para todos os outros componentes do computador?", options: ["Estabilizador", "Bateria", "Fonte de Alimentação", "No-break"], answer: "Fonte de Alimentação" },
            { id: 15, area: "Hardware", question: "PCI Express é um tipo de slot para...", options: ["RAM", "HD", "Placa de Vídeo", "Processador"], answer: "Placa de Vídeo" },
            { id: 16, area: "Hardware", question: "Qual a função de um no-break?", options: ["Aumentar a velocidade da internet", "Proteger contra vírus", "Fornecer energia temporária em caso de queda de luz", "Otimizar o desempenho da CPU"], answer: "Fornecer energia temporária em caso de queda de luz" },
            { id: 17, area: "Hardware", question: "O que é um 'byte'?", options: ["Uma unidade de CPU", "Oito bits", "Um tipo de vírus", "Um conector de placa mãe"], answer: "Oito bits" },

            // SOFTWARE & SISTEMAS OPERACIONAIS (17 Questões)
            { id: 18, area: "Software & Sistemas Operacionais", question: "Qual destes é um sistema operacional de código aberto?", options: ["Windows", "macOS", "Linux", "iOS"], answer: "Linux" },
            { id: 19, area: "Software & Sistemas Operacionais", question: "Qual software é usado para criar e editar documentos de texto?", options: ["Excel", "PowerPoint", "Word", "Outlook"], answer: "Word" },
            { id: 20, area: "Software & Sistemas Operacionais", question: "Um 'firewall' tem como principal função...", options: ["Acelerar a internet", "Proteger a rede contra acessos não autorizados", "Organizar arquivos", "Compactar dados"], answer: "Proteger a rede contra acessos não autorizados" },
            { id: 21, area: "Software & Sistemas Operacionais", question: "Qual o sistema operacional mais utilizado em smartphones?", options: ["Windows Phone", "iOS", "Android", "BlackBerry OS"], answer: "Android" },
            { id: 22, area: "Software & Sistemas Operacionais", question: "O que é um 'driver'?", options: ["Um tipo de vírus", "Um programa que permite ao SO interagir com um hardware", "Um software de navegação", "Um componente de rede"], answer: "Um programa que permite ao SO interagir com um hardware" },
            { id: 23, area: "Software & Sistemas Operacionais", question: "Qual atalho de teclado é usado para copiar um item?", options: ["Ctrl+X", "Ctrl+V", "Ctrl+C", "Ctrl+Z"], answer: "Ctrl+C" },
            { id: 24, area: "Software & Sistemas Operacionais", question: "No Windows, qual aplicativo é usado para gerenciar arquivos e pastas?", options: ["Painel de Controle", "Gerenciador de Tarefas", "Explorador de Arquivos", "Prompt de Comando"], answer: "Explorador de Arquivos" },
            { id: 25, area: "Software & Sistemas Operacionais", question: "Qual o principal objetivo de um antivírus?", options: ["Otimizar o sistema", "Proteger contra softwares maliciosos", "Compactar arquivos", "Navegar na internet"], answer: "Proteger contra softwares maliciosos" },
            { id: 26, area: "Software & Sistemas Operacionais", question: "Software proprietário é aquele que...", options: ["Pode ser modificado livremente", "Tem seu código fonte aberto", "É vendido sob licença de uso", "Não precisa de instalação"], answer: "É vendido sob licença de uso" },
            { id: 27, area: "Software & Sistemas Operacionais", question: "Qual destas NÃO é uma função de um sistema operacional?", options: ["Gerenciamento de memória", "Gerenciamento de processos", "Criação de gráficos 3D", "Interface com o usuário"], answer: "Criação de gráficos 3D" },
            { id: 28, area: "Software & Sistemas Operacionais", question: "O que é 'malware'?", options: ["Um tipo de hardware avançado", "Software malicioso", "Um erro de programação", "Um termo para internet lenta"], answer: "Software malicioso" },
            { id: 29, area: "Software & Sistemas Operacionais", question: "Em um sistema operacional, o que é um 'ícone'?", options: ["Um tipo de arquivo executável", "Uma representação gráfica de um programa ou arquivo", "Um comando de terminal", "Uma unidade de medida"], answer: "Uma representação gráfica de um programa ou arquivo" },
            { id: 30, area: "Software & Sistemas Operacionais", question: "Qual o nome do software que traduz o código fonte de um programa para código de máquina?", options: ["Editor de texto", "Navegador", "Compilador", "Processador de texto"], answer: "Compilador" },
            { id: 31, area: "Software & Sistemas Operacionais", question: "O que é 'multitarefa' em um sistema operacional?", options: ["Capacidade de rodar um único programa muito rápido", "Capacidade de executar vários programas simultaneamente", "Capacidade de conectar a várias redes", "Capacidade de processar apenas um tipo de dado"], answer: "Capacidade de executar vários programas simultaneamente" },
            { id: 32, area: "Software & Sistemas Operacionais", question: "Para que serve a tecla 'Print Screen'?", options: ["Imprimir o documento atual", "Tirar uma foto da tela", "Apagar arquivos", "Fechar um programa"], answer: "Tirar uma foto da tela" },
            { id: 33, area: "Software & Sistemas Operacionais", question: "Qual a extensão padrão para arquivos de texto simples?", options: [".doc", ".pdf", ".txt", ".exe"], answer: ".txt" },
            { id: 34, area: "Software & Sistemas Operacionais", question: "Um 'loop infinito' é um problema comum em...", options: ["Hardware", "Redes", "Programação", "Armazenamento"], answer: "Programação" },

            // REDES & INTERNET (16 Questões)
            { id: 35, area: "Redes & Internet", question: "O que significa 'HTTP'?", options: ["HyperText Transfer Protocol", "High-Tech Transfer Program", "Home Tool Transfer Process", "Hyperlink Texting Protocol"], answer: "HyperText Transfer Protocol" },
            { id: 36, area: "Redes & Internet", question: "Qual o nome do dispositivo que conecta múltiplas redes locais entre si e à internet?", options: ["Switch", "Hub", "Modem", "Roteador"], answer: "Roteador" },
            { id: 37, area: "Redes & Internet", question: "Um endereço IP (Internet Protocol) serve para...", options: ["Identificar um site na internet", "Identificar um dispositivo em uma rede", "Armazenar senhas", "Aumentar a velocidade de download"], answer: "Identificar um dispositivo em uma rede" },
            { id: 38, area: "Redes & Internet", question: "O que é 'phishing'?", options: ["Um tipo de hardware para pesca", "Uma técnica de fraude para roubar informações pessoais", "Um novo protocolo de rede", "Um software de edição de fotos"], answer: "Uma técnica de fraude para roubar informações pessoais" },
            { id: 39, "area": "Redes & Internet", question: "Qual serviço permite enviar e receber mensagens eletrônicas?", options: ["FTP", "SMTP", "E-mail", "DNS"], answer: "E-mail" },
            { id: 40, area: "Redes & Internet", question: "O que significa 'URL'?", options: ["Universal Resource Locator", "Uniform Remote Link", "User Request Language", "Unified Router Login"], answer: "Universal Resource Locator" },
            { id: 41, area: "Redes & Internet", question: "Qual é o principal protocolo para transferência de arquivos na internet?", options: ["HTTP", "TCP", "UDP", "FTP"], answer: "FTP" },
            { id: 42, area: "Redes & Internet", question: "Uma VPN (Rede Virtual Privada) é usada para...", options: ["Aumentar o número de conexões Wi-Fi", "Criar uma conexão segura e privada através de uma rede pública", "Armazenar arquivos na nuvem", "Otimizar o desempenho do computador"], answer: "Criar uma conexão segura e privada através de uma rede pública" },
            { id: 43, area: "Redes & Internet", question: "O que é um 'browser'?", options: ["Um tipo de servidor", "Um programa para navegar na internet", "Um dispositivo de rede", "Um sistema operacional"], answer: "Um programa para navegar na internet" },
            { id: 44, area: "Redes & Internet", question: "HTTPS é uma versão segura de qual protocolo?", options: ["FTP", "HTTP", "SMTP", "DNS"], answer: "HTTP" },
            { id: 45, area: "Redes & Internet", question: "Qual o termo para uma rede de computadores dentro de uma área geográfica limitada (ex: um escritório)?", options: ["WAN", "LAN", "MAN", "GAN"], answer: "LAN" },
            { id: 46, area: "Redes & Internet", question: "Um 'servidor DNS' é responsável por...", options: ["Distribuir endereços IP", "Traduzir nomes de domínio para endereços IP", "Hospedar websites", "Gerenciar o tráfego de e-mails"], answer: "Traduzir nomes de domínio para endereços IP" },
            { id: 47, area: "Redes & Internet", question: "Qual o principal meio de comunicação utilizado pela internet?", options: ["Rede Wi-Fi", "Cabos de rede", "Ondas de rádio", "Fibras ópticas"], answer: "Fibras ópticas" },
            { id: 48, area: "Redes & Internet", question: "O que é 'spam' em e-mail?", options: ["Mensagens importantes", "E-mails indesejados em massa", "Anexos de arquivo", "Notificações de sistema"], answer: "E-mails indesejados em massa" },
            { id: 49, area: "Redes & Internet", question: "Qual dos seguintes é um exemplo de navegador de internet?", options: ["Microsoft Word", "Google Chrome", "Adobe Photoshop", "Windows Explorer"], answer: "Google Chrome" },
            { id: 50, area: "Redes & Internet", question: "Uma 'URL' é usada para...", options: ["Identificar um usuário", "Localizar um recurso na internet", "Conectar a um servidor", "Compactar arquivos"], answer: "Localizar um recurso na internet" }
        ];

        let questions = []; // Array que conterá as perguntas ativas (do localStorage ou iniciais)

        let studentName = "";
        let currentQuestionIndex = 0;
        let score = 0;
        let answers = []; // Armazena a opção selecionada pelo usuário
        let attempts = []; // Armazena o número de tentativas para cada pergunta
        let correctAnswersByArea = {}; // Armazena contagem de acertos por área
        let totalQuestionsByArea = {}; // Armazena total de questões por área
        let startTime = null;

        // Elementos do Login/Registro Pop-up
        const loginPopup = document.getElementById('login-popup');
        const formTitle = document.getElementById('form-title');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');

        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const showRegisterButton = document.getElementById('show-register-button');

        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const registerPasswordConfirmInput = document.getElementById('register-password-confirm');
        const registerButton = document.getElementById('register-button');
        const showLoginButton = document.getElementById('show-login-button');

        const mainContentWrapper = document.getElementById('main-content-wrapper');

        // Usuários e senhas iniciais (ATENÇÃO: APENAS PARA DEMONSTRAÇÃO)
        const initialUsers = {
            "admin": "12345", // Admin user with access to the control panel
            "aluno": "senha123",
            "teste": "teste"
        };
        // Variável que irá armazenar os usuários carregados/salvos
        let users = {};

        const startScreen = document.getElementById('start-screen');
        const studentNameInput = document.getElementById('student-name-input');
        const startQuizButton = document.getElementById('start-quiz-button');

        const quizSection = document.getElementById('quiz');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const resultDiv = document.getElementById('result'); // Mantido para limpeza, mas com display:none

        const reportSection = document.getElementById('report-section');
        const reportStudentName = document.getElementById('report-student-name');
        const reportTimeTaken = document.getElementById('report-time-taken');
        const reportScore = document.getElementById('report-score');
        const reportTotalQuestions = document.getElementById('report-total-questions');
        const reportAverage = document.getElementById('report-average');
        const reportCanvas = document.getElementById('report-canvas'); // Gráfico Geral
        const areaReportCanvas = document.getElementById('area-report-canvas'); // Gráfico por Área
        const detailedResults = document.getElementById('detailed-results');
        const restartButtonReport = document.getElementById('restart-button-report');
        const exportPdfButton = document.getElementById('export-pdf-button');
        const exportSheetsButton = document.getElementById('export-sheets-button'); // NOVO BOTÃO
        const reportButtons = document.getElementById('report-buttons'); // Referência aos botões para esconder/mostrar na exportação do PDF

        // Elementos do Painel de Controle Admin
        const adminPanel = document.getElementById('admin-panel');
        const addQuestionButton = document.getElementById('add-question-button');
        const questionsList = document.getElementById('questions-list');
        const closeAdminPanelButton = document.getElementById('close-admin-panel-button');

        // Elementos do Modal de Edição/Adição
        const editQuestionModal = document.getElementById('edit-question-modal');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editQuestionId = document.getElementById('edit-question-id');
        const editQuestionArea = document.getElementById('edit-question-area');
        const editQuestionText = document.getElementById('edit-question-text');
        const editOptionInputs = [
            document.getElementById('edit-option-1'),
            document.getElementById('edit-option-2'),
            document.getElementById('edit-option-3'),
            document.getElementById('edit-option-4')
        ];
        const editCorrectAnswerSelect = document.getElementById('edit-correct-answer');
        const saveQuestionButton = document.getElementById('save-question-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        // URL do Google Apps Script Web App
        // Substitua 'YOUR_WEB_APP_URL_HERE' pela URL real do seu Web App no Google Apps Script
        let webAppUrl = 'YOUR_WEB_APP_URL_HERE';


        // --- Funções de Manipulação de Usuários (localStorage) ---
        function loadUsers() {
            try {
                const storedUsers = localStorage.getItem('quizUsers');
                if (storedUsers) {
                    users = JSON.parse(storedUsers);
                } else {
                    // Se não houver usuários salvos, usa os iniciais e salva
                    users = { ...initialUsers };
                    saveUsers();
                }
            } catch (e) {
                console.error("Erro ao carregar usuários do localStorage:", e);
                users = { ...initialUsers }; // Volta para os usuários iniciais em caso de erro
            }
        }

        function saveUsers() {
            try {
                localStorage.setItem('quizUsers', JSON.stringify(users));
            } catch (e) {
                console.error("Erro ao salvar usuários no localStorage:", e);
            }
        }

        // --- Funções de Login e Registro ---
        function handleLogin() {
            const username = loginUsernameInput.value;
            const password = loginPasswordInput.value;

            if (users[username] === password) {
                loginPopup.style.display = 'none'; // Esconde o pop-up
                if (username === "admin") {
                    showAdminPanel(); // Se for admin, mostra o painel de controle
                } else {
                    mainContentWrapper.style.display = 'block'; // Senão, mostra o conteúdo principal do quiz
                }
                alert('Login bem-sucedido! Bem-vindo(a), ' + username + '!');
            } else {
                alert('Usuário ou senha incorretos. Tente novamente ou registre-se.');
                loginPasswordInput.value = ''; // Limpa o campo da senha
            }
        }

        function handleRegister() {
            const username = registerUsernameInput.value.trim();
            const password = registerPasswordInput.value;
            const confirmPassword = registerPasswordConfirmInput.value;

            if (username === "" || password === "" || confirmPassword === "") {
                alert("Por favor, preencha todos os campos para o registro.");
                return;
            }

            if (password !== confirmPassword) {
                alert("As senhas não coincidem. Por favor, digite novamente.");
                registerPasswordInput.value = '';
                registerPasswordConfirmInput.value = '';
                return;
            }

            if (users[username]) {
                alert("Este nome de usuário já existe. Por favor, escolha outro.");
                return;
            }

            // Adiciona o novo usuário
            users[username] = password;
            saveUsers(); // Salva no localStorage

            alert('Usuário "' + username + '" registrado com sucesso! Você já pode fazer login.');
            // Volta para o formulário de login
            loginUsernameInput.value = username;
            loginPasswordInput.value = '';
            showLoginForm();
        }

        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            formTitle.textContent = 'Registrar Nova Conta';
            registerUsernameInput.value = '';
            registerPasswordInput.value = '';
            registerPasswordConfirmInput.value = '';
            registerUsernameInput.focus();
        }

        function showLoginForm() {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            formTitle.textContent = 'Acessar Quiz';
            loginUsernameInput.focus();
        }

        // --- Funções de Manipulação de Perguntas (localStorage) ---
        function loadQuestionsFromLocalStorage() {
            try {
                const storedQuestions = localStorage.getItem('quizQuestions');
                if (storedQuestions) {
                    questions = JSON.parse(storedQuestions);
                } else {
                    // Se não houver perguntas salvas, usa as iniciais e salva
                    questions = [...initialQuestions];
                    saveQuestionsToLocalStorage();
                }
            } catch (e) {
                console.error("Erro ao carregar perguntas do localStorage:", e);
                questions = [...initialQuestions]; // Volta para as perguntas iniciais em caso de erro
            }
            // Garante que todos os IDs sejam únicos e sequenciais para novas perguntas
            questions.forEach((q, index) => q.id = index + 1);
        }

        function saveQuestionsToLocalStorage() {
            try {
                localStorage.setItem('quizQuestions', JSON.stringify(questions));
                // Após salvar, re-inicializa os contadores de área para refletir as mudanças
                initializeAreaCounters();
            } catch (e) {
                console.error("Erro ao salvar perguntas no localStorage:", e);
            }
        }


        // --- Funções do Painel de Controle Admin ---
        function showAdminPanel() {
            adminPanel.style.display = 'flex';
            loadQuestionsForAdminPanel();
        }

        function closeAdminPanel() {
            adminPanel.style.display = 'none';
            // Opcional: Voltar para a tela de login ou a tela inicial do quiz
            loginPopup.style.display = 'flex'; // Volta para o login
            // mainContentWrapper.style.display = 'block'; // Se quiser voltar para a tela do quiz diretamente
        }

        function loadQuestionsForAdminPanel() {
            questionsList.innerHTML = ''; // Limpa a lista existente

            if (questions.length === 0) {
                const li = document.createElement('li');
                li.textContent = "Nenhuma pergunta cadastrada. Adicione uma!";
                questionsList.appendChild(li);
                return;
            }

            questions.forEach((q, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>${index + 1}. [${q.area}] ${q.question}</strong>
                    <span>Opções: ${q.options.join(', ')}</span>
                    <span>Resposta Correta: ${q.answer}</span>
                    <div class="actions">
                        <button class="edit-btn" data-id="${q.id}">Editar</button>
                        <button class="delete-btn" data-id="${q.id}">Excluir</button>
                    </div>
                `;
                questionsList.appendChild(li);
            });

            // Adiciona event listeners aos botões de editar e excluir
            questionsList.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const questionId = parseInt(e.target.dataset.id);
                    openEditQuestionModal(questionId);
                });
            });

            questionsList.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const questionId = parseInt(e.target.dataset.id);
                    deleteQuestion(questionId);
                });
            });
        }

        function openEditQuestionModal(questionId = null) {
            editQuestionModal.style.display = 'flex';
            resetEditModalForm();

            if (questionId) {
                // Modo de edição
                editModalTitle.textContent = 'Editar Pergunta';
                const questionToEdit = questions.find(q => q.id === questionId);
                if (questionToEdit) {
                    editQuestionId.value = questionToEdit.id;
                    editQuestionArea.value = questionToEdit.area;
                    editQuestionText.value = questionToEdit.question;
                    questionToEdit.options.forEach((option, i) => {
                        if (editOptionInputs[i]) {
                            editOptionInputs[i].value = option;
                        }
                    });
                    // Preencher e selecionar a resposta correta
                    updateCorrectAnswerSelect(questionToEdit.options, questionToEdit.answer);
                }
            } else {
                // Modo de adição
                editModalTitle.textContent = 'Adicionar Nova Pergunta';
                editQuestionId.value = ''; // Novo ID será gerado ao salvar
                // Preencher o select de resposta correta com base nas opções vazias
                updateCorrectAnswerSelect(editOptionInputs.map(input => input.value));
            }

            // Atualiza o select de resposta correta sempre que uma opção é modificada
            editOptionInputs.forEach(input => {
                input.addEventListener('input', () => {
                    const currentOptions = editOptionInputs.map(optInput => optInput.value);
                    updateCorrectAnswerSelect(currentOptions, editCorrectAnswerSelect.value);
                });
            });
        }

        function updateCorrectAnswerSelect(options, selectedValue = '') {
            editCorrectAnswerSelect.innerHTML = '';
            options.forEach(option => {
                if (option.trim() !== '') { // Adiciona apenas opções não vazias
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    editCorrectAnswerSelect.appendChild(opt);
                }
            });
            // Tenta selecionar o valor correto, se existir
            if (selectedValue && Array.from(editCorrectAnswerSelect.options).some(opt => opt.value === selectedValue)) {
                editCorrectAnswerSelect.value = selectedValue;
            } else if (editCorrectAnswerSelect.options.length > 0) {
                 // Se o valor selecionado não existir ou não foi fornecido, seleciona o primeiro
                editCorrectAnswerSelect.selectedIndex = 0;
            }
        }


        function resetEditModalForm() {
            editQuestionId.value = '';
            editQuestionArea.value = 'Hardware';
            editQuestionText.value = '';
            editOptionInputs.forEach(input => input.value = '');
            editCorrectAnswerSelect.innerHTML = ''; // Limpa as opções
        }

        function saveQuestion() {
            const id = editQuestionId.value ? parseInt(editQuestionId.value) : null;
            const area = editQuestionArea.value;
            const questionText = editQuestionText.value.trim();
            const options = editOptionInputs.map(input => input.value.trim()).filter(Boolean); // Filtra opções vazias
            const correctAnswer = editCorrectAnswerSelect.value;

            if (!questionText || options.length < 2 || !correctAnswer) {
                alert("Por favor, preencha a pergunta, pelo menos duas opções e selecione a resposta correta.");
                return;
            }
            if (!options.includes(correctAnswer)) {
                 alert("A resposta correta deve ser uma das opções fornecidas.");
                return;
            }

            if (id) {
                // Edição de pergunta existente
                const index = questions.findIndex(q => q.id === id);
                if (index !== -1) {
                    questions[index] = { id: id, area, question: questionText, options, answer: correctAnswer };
                }
            } else {
                // Adição de nova pergunta
                const newId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1;
                questions.push({ id: newId, area, question: questionText, options, answer: correctAnswer });
            }

            saveQuestionsToLocalStorage();
            loadQuestionsForAdminPanel(); // Recarrega a lista no painel
            editQuestionModal.style.display = 'none'; // Fecha o modal
            alert("Pergunta salva com sucesso!");
        }

        function deleteQuestion(questionId) {
            if (confirm("Tem certeza que deseja excluir esta pergunta?")) {
                questions = questions.filter(q => q.id !== questionId);
                // Re-atribui IDs para manter a sequência, se desejar
                questions.forEach((q, index) => q.id = index + 1);
                saveQuestionsToLocalStorage();
                loadQuestionsForAdminPanel();
                alert("Pergunta excluída com sucesso!");
            }
        }

        // --- Funções do Quiz ---
        function startQuiz() {
            studentName = studentNameInput.value.trim();
            if (!studentName) {
                alert("Por favor, digite seu nome para iniciar o quiz.");
                return;
            }
            // Reinicializa o quiz ao iniciar
            currentQuestionIndex = 0;
            score = 0;
            answers = new Array(questions.length).fill(null);
            attempts = new Array(questions.length).fill(0); // Inicializa tentativas para todas as perguntas

            startScreen.style.display = 'none';
            quizSection.style.display = 'block';
            startTime = new Date(); // Inicia o cronômetro
            loadQuestion();
        }

        function loadQuestion() {
            if (questions.length === 0) {
                questionText.innerHTML = "Nenhuma pergunta disponível para o quiz. Por favor, adicione perguntas no painel de controle.";
                optionsContainer.innerHTML = '';
                prevButton.disabled = true;
                nextButton.disabled = true;
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];
            // Atualiza o texto da pergunta com o número de tentativas
            questionText.innerHTML = `${currentQuestion.question} <span class="attempt-count">(Tentativas: ${attempts[currentQuestionIndex]})</span>`;
            optionsContainer.innerHTML = '';
            resultDiv.textContent = ''; // Limpa o resultado ao carregar nova pergunta

            currentQuestion.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                button.addEventListener('click', () => selectOption(option, button));
                optionsContainer.appendChild(button);

                // Re-aplica a classe 'selected' se já houver uma resposta para esta pergunta
                if (answers[currentQuestionIndex] === option) {
                    button.classList.add('selected');
                }
            });

            prevButton.disabled = currentQuestionIndex === 0;
            nextButton.textContent = currentQuestionIndex === questions.length - 1 ? 'Finalizar Quiz' : 'Próxima';
            //Não desabilitar opções aqui para permitir múltiplas tentativas na mesma pergunta
            //enableOptions();
        }

        function selectOption(selectedOption, clickedButton) {
            // Remove a seleção anterior
            Array.from(optionsContainer.children).forEach(button => {
                button.classList.remove('selected');
            });
            clickedButton.classList.add('selected');

            // Incrementa tentativas apenas se a resposta mudou (ou se é a primeira vez)
            if (answers[currentQuestionIndex] !== selectedOption) {
                attempts[currentQuestionIndex]++;
                questionText.innerHTML = `${questions[currentQuestionIndex].question} <span class="attempt-count">(Tentativas: ${attempts[currentQuestionIndex]})</span>`;
            }
            answers[currentQuestionIndex] = selectedOption; // Armazena a opção selecionada
        }

        // Funções disableOptions e enableOptions removidas pois não há feedback imediato

        function calculateScore() {
            score = 0;
            // Zera os contadores de área para recalcular
            for (const area in correctAnswersByArea) {
                correctAnswersByArea[area] = 0;
            }

            questions.forEach((q, index) => {
                const userAnswer = answers[index];
                if (userAnswer === q.answer) {
                    score++;
                    correctAnswersByArea[q.area]++;
                }
            });
            console.log("Acertos por área:", correctAnswersByArea);
        }

        function finishQuiz() {
            calculateScore();
            const endTime = new Date();
            const timeTakenSeconds = (endTime - startTime) / 1000;

            quizSection.style.display = 'none';
            generateReport(timeTakenSeconds);
        }

        // --- Funções do Relatório ---
        function generateReport(timeTakenSeconds) {
            reportSection.style.display = 'block';

            reportStudentName.textContent = studentName;
            reportTimeTaken.textContent = timeTakenSeconds.toFixed(1);
            reportScore.textContent = score;
            reportTotalQuestions.textContent = questions.length;
            reportAverage.textContent = ((score / questions.length) * 100).toFixed(2);

            // Gráfico de Desempenho Geral (Pizza/Doughnut)
            const correctAnswers = score;
            const incorrectAnswers = questions.length - score;

            if (window.myChart) {
                window.myChart.destroy();
            }
            window.myChart = new Chart(reportCanvas, {
                type: 'doughnut',
                data: {
                    labels: ['Acertos', 'Erros'],
                    datasets: [{
                        data: [correctAnswers, incorrectAnswers],
                        backgroundColor: [
                            '#4CAF50', // Verde para acertos
                            '#F44336'  // Vermelho para erros
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#333' } },
                        title: { display: true, text: 'Desempenho Geral', color: '#333' }
                    },
                    cutout: '70%',
                }
            });

            // Gráfico de Desempenho por Área (Barras)
            const areaLabels = Object.keys(totalQuestionsByArea);
            const areaScores = areaLabels.map(area => correctAnswersByArea[area]);
            const areaMaxScores = areaLabels.map(area => totalQuestionsByArea[area]);

            if (window.areaChart) {
                window.areaChart.destroy();
            }
            window.areaChart = new Chart(areaReportCanvas, {
                type: 'bar',
                data: {
                    labels: areaLabels,
                    datasets: [{
                        label: 'Acertos por Área',
                        data: areaScores,
                        backgroundColor: [
                            '#3f51b5', // Cor para Hardware
                            '#00bcd4', // Cor para Software
                            '#ff9800'  // Cor para Redes
                        ],
                        borderColor: [
                            '#283593',
                            '#00838f',
                            '#e65100'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Desempenho por Área de Conhecimento', color: '#333' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(...areaMaxScores) + 1, // Ajusta o máximo do eixo Y
                            title: {
                                display: true,
                                text: 'Número de Acertos',
                                color: '#333'
                            },
                            ticks: {
                                color: '#333'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Área do Conhecimento',
                                color: '#333'
                            },
                             ticks: {
                                color: '#333'
                            }
                        }
                    }
                }
            });


            // Adicionar resultados detalhados
            detailedResults.innerHTML = '<h3>Respostas Detalhadas:</h3>'; // Limpa antes de adicionar
            questions.forEach((q, index) => {
                const userAnswer = answers[index];
                const isCorrect = (userAnswer === q.answer);

                const resultDiv = document.createElement('div');
                resultDiv.classList.add('question-result');
                resultDiv.classList.add(isCorrect ? 'correct-q' : 'wrong-q');

                resultDiv.innerHTML = `
                    <p class="q-text"><strong>${index + 1}. [${q.area}] ${q.question}</strong></p>
                    <p>Sua Resposta: <span class="user-answer">${userAnswer || 'Não respondido'}</span></p>
                    <p>Resposta Correta: <span class="correct-answer">${q.answer}</span></p>
                    <p>Status: ${isCorrect ? '&#10003; Correta' : '&#10007; Incorreta'}</p>
                    <p class="attempt-count-report">Tentativas: ${attempts[index]}</p>
                `;
                detailedResults.appendChild(resultDiv);
            });
        }

        function exportPdf() {
            // Esconde os botões do relatório para não aparecerem no PDF
            reportButtons.style.display = 'none';

            // Usa html2canvas para renderizar o report-section como uma imagem
            html2canvas(reportSection, {
                scale: 2, // Maior escala para melhor qualidade no PDF
                useCORS: true, // Importante se tiver imagens externas (não o caso aqui, mas boa prática)
                backgroundColor: '#e0f2f7' // Define o fundo azul clarinho para a captura do canvas
            }).then(canvas => {
                // Adiciona os botões de volta após a captura
                reportButtons.style.display = 'flex';

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' para retrato, 'mm' para milímetros, 'a4' para tamanho de página

                const imgWidth = 210; // Largura do A4 em mm
                const pageHeight = 297; // Altura do A4 em mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Se o conteúdo for maior que uma página, adicione mais páginas
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`Relatorio_Quiz_${studentName.replace(/\s+/g, '_') || 'Aluno'}.pdf`);
                alert('PDF gerado com sucesso!');
            });
        }

        async function exportToGoogleSheets() {
            if (!webAppUrl || webAppUrl === 'YOUR_WEB_APP_URL_HERE') {
                alert("A URL do Google Apps Script Web App não foi configurada. Por favor, configure-a no código.");
                return;
            }

            alert("Exportando dados para Planilhas Google... Isso pode levar alguns segundos.");
            exportSheetsButton.disabled = true; // Desabilita o botão para evitar cliques múltiplos

            const timeTakenSeconds = (new Date() - startTime) / 1000;
            const totalQuestions = questions.length;
            const averagePercentage = ((score / totalQuestions) * 100).toFixed(2);

            // Coleta os resultados detalhados para enviar
            const detailedResults = questions.map((q, index) => {
                const userAnswer = answers[index];
                const isCorrect = (userAnswer === q.answer);
                return {
                    // Incluir texto da pergunta para o Google Sheet ser mais descritivo
                    questionText: q.question,
                    userAnswer: userAnswer || 'Não respondido',
                    correctAnswer: q.answer,
                    status: isCorrect ? 'Correta' : 'Incorreta',
                    attempts: attempts[index]
                };
            });

            // Prepara os dados para enviar
            const dataToSend = {
                studentName: studentName,
                timeTaken: timeTakenSeconds.toFixed(1),
                score: score,
                totalQuestions: totalQuestions,
                average: averagePercentage,
                acertosHardware: correctAnswersByArea["Hardware"] || 0,
                acertosSoftwareSO: correctAnswersByArea["Software & Sistemas Operacionais"] || 0,
                acertosRedesInternet: correctAnswersByArea["Redes & Internet"] || 0,
                detailedResults: JSON.stringify(detailedResults) // Envia como JSON string
            };

            // Usa FormData para simular um envio de formulário POST
            const formData = new FormData();
            for (const key in dataToSend) {
                formData.append(key, dataToSend[key]);
            }

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // Use 'no-cors' para evitar problemas de CORS, mas você não poderá ler a resposta do script
                });

                // Como usamos 'no-cors', não podemos ler a resposta diretamente.
                // A melhor forma de verificar o sucesso é olhando a planilha.
                alert("Dados enviados para as Planilhas Google! Verifique sua planilha.");
                exportSheetsButton.disabled = false;

            } catch (error) {
                console.error('Erro ao exportar para Planilhas Google:', error);
                alert("Ocorreu um erro ao exportar para Planilhas Google. Verifique o console para mais detalhes.");
                exportSheetsButton.disabled = false;
            }
        }


        // --- Event Listeners ---
        loginButton.addEventListener('click', handleLogin);
        registerButton.addEventListener('click', handleRegister);
        showRegisterButton.addEventListener('click', showRegisterForm);
        showLoginButton.addEventListener('click', showLoginForm);

        // Permite login/registro com Enter nos campos de texto
        loginUsernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
        loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
        registerUsernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleRegister(); });
        registerPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleRegister(); });
        registerPasswordConfirmInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleRegister(); });


        startQuizButton.addEventListener('click', startQuiz);

        prevButton.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        });

        nextButton.addEventListener('click', () => {
             // Verifica se uma opção foi selecionada para a pergunta atual
             if (answers[currentQuestionIndex] === null) {
                alert('Por favor, selecione uma resposta antes de prosseguir.');
                return;
             }

            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                finishQuiz();
            }
        });

        restartButtonReport.addEventListener('click', () => {
            currentQuestionIndex = 0;
            score = 0;
            answers = new Array(questions.length).fill(null);
            attempts = new Array(questions.length).fill(0); // Reinicializa tentativas
            correctAnswersByArea = {}; // Zera os contadores de área
            totalQuestionsByArea = {}; // Zera os contadores de área
            initializeAreaCounters(); // Reinicializa os contadores
            startTime = null;
            reportSection.style.display = 'none';
            studentNameInput.value = ''; // Limpa o nome do aluno
            startScreen.style.display = 'flex'; // Volta para a tela de início

            // Após reiniciar, volta para a tela de login
            mainContentWrapper.style.display = 'none';
            loginPopup.style.display = 'flex';
            loginUsernameInput.value = '';
            loginPasswordInput.value = '';
            loginUsernameInput.focus();
        });

        exportPdfButton.addEventListener('click', exportPdf);
        exportSheetsButton.addEventListener('click', exportToGoogleSheets); // NOVO EVENT LISTENER

        // Event Listeners do Painel Admin
        addQuestionButton.addEventListener('click', () => openEditQuestionModal());
        closeAdminPanelButton.addEventListener('click', closeAdminPanel);

        // Event Listeners do Modal de Edição/Adição
        saveQuestionButton.addEventListener('click', saveQuestion);
        cancelEditButton.addEventListener('click', () => editQuestionModal.style.display = 'none');


        // --- Inicializa contadores de área (reflete o total de perguntas por área) ---
        function initializeAreaCounters() {
            // Primeiro, zera os contadores
            totalQuestionsByArea = {};
            correctAnswersByArea = {};

            questions.forEach(q => {
                if (!totalQuestionsByArea[q.area]) {
                    totalQuestionsByArea[q.area] = 0;
                    correctAnswersByArea[q.area] = 0; // Também zera os acertos para cada área
                }
                totalQuestionsByArea[q.area]++;
            });
            console.log("Totais de questões por área (atualizado):", totalQuestionsByArea);
        }

        // --- Inicialização Geral da Página ---
        loadUsers(); // Carrega os usuários salvos (ou os iniciais)
        loadQuestionsFromLocalStorage(); // Carrega as perguntas salvas (ou as iniciais)
        initializeAreaCounters(); // Inicializa os contadores de área com base nas perguntas carregadas

    </script>
</body>
</html>
