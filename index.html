<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Avaliação de Quiz</title>
    <style>
        /* Estilos Base */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
        }

        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group input[type="password"],
        .input-group textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .input-group input[type="text"]:focus,
        .input-group input[type="number"]:focus,
        .input-group input[type="password"]:focus,
        .input-group textarea:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .button-group {
            text-align: center;
            margin-top: 20px;
        }

        .action-button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: background-color 0.3s ease;
        }

        .action-button:hover {
            background-color: #0056b3;
        }

        .action-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .action-button.secondary {
            background-color: #6c757d;
        }

        .action-button.secondary:hover {
            background-color: #5a6268;
        }

        .action-button.danger {
            background-color: #dc3545;
        }

        .action-button.danger:hover {
            background-color: #c82333;
        }

        /* Estilos do Quiz */
        #question-area {
            text-align: center;
            margin-top: 30px;
        }

        #question-area h3 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #34495e;
        }

        #options-container button {
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 15px 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f8f9fa;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            text-align: left;
        }

        #options-container button:hover {
            background-color: #e2e6ea;
            border-color: #b8c1cb;
        }

        #options-container button.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        #options-container button.correct {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        #options-container button.incorrect {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        #feedback-message {
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }

        #feedback-message.correct {
            color: #28a745;
        }

        #feedback-message.incorrect {
            color: #dc3545;
        }

        #timer, #current-score {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
            color: #4CAF50;
        }

        #current-score {
            color: #FF5722;
        }
        
        /* Estilos para o cronômetro de penalidade */
        #penalty-status {
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            margin-top: 5px;
            color: black; 
            padding: 8px;
            border: 2px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0; 
            display: none; /* Inicia oculto */
        }
        #penalty-status.active {
            color: white;
            border-color: #dc3545; /* Borda vermelha */
            background-color: #dc3545; /* Fundo vermelho */
            display: block; /* Torna visível quando ativo */
        }

        /* Estilos do Relatório */
        #report-area table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #report-area th, #report-area td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        #report-area th {
            background-color: #f2f2f2;
            color: #333;
        }

        /* Utilidades */
        .hidden {
            display: none;
        }

        .admin-only {
            display: none;
        }

        body.admin-mode .admin-only {
            display: block; /* Ou flex, conforme o caso do layout */
        }

        /* Gerenciamento de Perguntas */
        #question-management-area .question-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
            margin-top: 15px;
        }

        .question-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .question-list-item:last-child {
            border-bottom: none;
        }

        .question-list-item .question-text {
            flex-grow: 1;
            margin-right: 10px;
        }

        .question-list-item button {
            padding: 5px 10px;
            margin-left: 5px;
            font-size: 0.9em;
        }
        .question-form .option-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .question-form .option-input-group input[type="text"] {
            flex-grow: 1;
            margin-right: 5px;
        }
        .question-form .option-input-group input[type="radio"] {
            margin-left: 5px;
            min-width: 20px; /* Para melhor clique em telas pequenas */
        }

        /* Estilos para impressão (Exportar PDF) */
        @media print {
            body {
                background-color: #fff;
                color: #000;
                padding: 0;
                margin: 0;
            }
            .container {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                width: 100%;
                max-width: none;
            }
            .section {
                border: none;
                background-color: #fff;
                padding: 0;
                margin-bottom: 10px;
            }
            /* Oculta tudo que não deve ser impresso */
            #login-area,
            #register-area,
            #main-menu-area,
            #quiz-area,
            #question-management-area,
            .button-group, /* Oculta todos os grupos de botões */
            .hidden, /* Qualquer elemento que já está oculto */
            .admin-only, /* Elementos de admin */
            /* Botões específicos no relatório */
            #export-pdf-button,
            #back-to-menu-from-report
             {
                display: none !important;
            }

            /* Garante que a área de relatório seja visível para impressão */
            #report-area {
                display: block !important;
                position: relative;
                margin: 20px;
            }

            /* Estilos de tabela para impressão */
            #report-area table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }
            #report-area th, #report-area td {
                border: 1px solid #999;
                padding: 8px;
                font-size: 0.9em;
            }
            #report-area th {
                background-color: #e0e0e0;
                color: #333;
            }

            /* Ajustes finos de texto */
            h1, h2, h3 {
                color: #000;
                margin-top: 15px;
                margin-bottom: 10px;
            }
            p {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-area" class="section">
            <h1>Login</h1>
            <div class="input-group">
                <label for="username">Usuário:</label>
                <input type="text" id="username" autocomplete="username">
            </div>
            <div class="input-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" autocomplete="current-password">
            </div>
            <div class="button-group">
                <button id="login-button" class="action-button">Entrar</button>
                <button id="show-register-button" class="action-button secondary">Registrar</button>
            </div>
        </div>

        <div id="register-area" class="section hidden">
            <h1>Registro de Novo Usuário</h1>
            <div class="input-group">
                <label for="new-username">Escolha um Usuário:</label>
                <input type="text" id="new-username" autocomplete="new-username">
            </div>
            <div class="input-group">
                <label for="new-password">Escolha uma Senha:</label>
                <input type="password" id="new-password" autocomplete="new-password">
            </div>
            <div class="button-group">
                <button id="register-user-button" class="action-button">Registrar</button>
                <button id="back-to-login-button" class="action-button secondary">Voltar ao Login</button>
            </div>
        </div>

        <div id="main-menu-area" class="section hidden">
            <h1>Menu Principal</h1>
            <div class="button-group">
                <button id="start-quiz-button" class="action-button">Iniciar Quiz</button>
                <button id="manage-questions-button" class="action-button secondary admin-only">Gerenciar Perguntas</button>
                <button id="view-report-button" class="action-button secondary admin-only">Ver Relatório Individual</button>
                <button id="export-general-report-button" class="action-button secondary admin-only">Exportar Relatório Geral (Excel)</button>
                <button id="logout-button" class="action-button danger">Sair</button>
            </div>
        </div>

        <div id="quiz-area" class="section hidden">
            <h2 id="quiz-title">Quiz de Sistemas Operacionais</h2>
            <div id="timer">Tempo: 0s</div>
            <div id="current-score">Acertos: 0</div>
            <div id="penalty-status">Tempo fora da prova: 0s</div>
            <div id="question-area">
                <h3 id="question-text"></h3>
                <div id="options-container">
                    </div>
                <div id="feedback-message"></div>
                <div class="button-group">
                    <button id="submit-answer-button" class="action-button">Próxima Pergunta</button>
                </div>
            </div>
        </div>

        <div id="report-area" class="section hidden">
            <h2>Relatório do Quiz</h2>
            <p><strong>Nome do Aluno:</strong> <span id="report-student-name"></span></p>
            <p><strong>Acertos:</strong> <span id="report-score"></span> / <span id="report-total-questions"></span></p>
            <p><strong>Porcentagem de Acerto:</strong> <span id="report-average"></span>%</p>
            <p><strong>Tempo Total do Quiz (sem penalidades):</strong> <span id="report-time-taken"></span> segundos</p>
            <p><strong>Penalidade por Respostas Erradas:</strong> <span id="report-wrong-answer-penalty-time"></span> segundos</p>
            <p><strong>Penalidade por Perda de Foco:</strong> <span id="report-focus-penalty-time"></span> segundos</p>

            <h3>Resultados Detalhados por Pergunta:</h3>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Pergunta</th>
                        <th>Sua Resposta</th>
                        <th>Resposta Correta</th>
                        <th>Status</th>
                        <th>Tempo na Questão (s)</th>
                        <th>Penalidade de Foco (s)</th>
                    </tr>
                </thead>
                <tbody id="detailed-results-body">
                    </tbody>
            </table>
            <div class="button-group">
                <button id="export-pdf-button" class="action-button secondary">Exportar para PDF (imprimir)</button> 
                <button id="back-to-menu-from-report" class="action-button danger">Voltar ao Menu</button>
            </div>
        </div>

        <div id="question-management-area" class="section hidden">
            <h2>Gerenciar Perguntas</h2>

            <h3>Adicionar Nova Pergunta</h3>
            <div class="question-form">
                <div class="input-group">
                    <label for="new-question-text">Pergunta:</label>
                    <textarea id="new-question-text" placeholder="Digite a pergunta"></textarea>
                </div>
                <div id="new-question-options-container">
                    <label>Opções:</label>
                    <div class="option-input-group">
                        <input type="text" class="new-option-text" placeholder="Opção 1">
                        <label>Correta?</label><input type="radio" name="correct-option" class="new-option-radio" value="0">
                    </div>
                    <div class="option-input-group">
                        <input type="text" class="new-option-text" placeholder="Opção 2">
                        <label>Correta?</label><input type="radio" name="correct-option" class="new-option-radio" value="1">
                    </div>
                    <div class="option-input-group">
                        <input type="text" class="new-option-text" placeholder="Opção 3">
                        <label>Correta?</label><input type="radio" name="correct-option" class="new-option-radio" value="2">
                    </div>
                    <div class="option-input-group">
                        <input type="text" class="new-option-text" placeholder="Opção 4">
                        <label>Correta?</label><input type="radio" name="correct-option" class="new-option-radio" value="3">
                    </div>
                </div>
                <div class="button-group">
                    <button id="add-question-button" class="action-button">Adicionar Pergunta</button>
                </div>
            </div>

            <h3>Perguntas Atuais</h3>
            <div class="question-list" id="current-questions-list">
                </div>
            <div class="button-group">
                <button id="back-to-menu-from-manage" class="action-button secondary">Voltar ao Menu</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configurações Globais ---
        const PENALTY_WRONG_ANSWER_SECONDS = 5;      // Penalidade em segundos por resposta errada
        const FOCUS_PENALTY_PER_SECOND = 1;          // Penalidade em segundos por segundo fora de foco
        const MIN_FOCUS_PENALTY_SECONDS = 3;         // Penalidade mínima de foco, mesmo para saídas rápidas
        const QUIZ_FEEDBACK_DELAY_MS = 1500;         // Tempo em milissegundos para mostrar feedback antes da próxima pergunta

        // --- Dados Iniciais (Perguntas e Usuários) ---
        // Estas perguntas são o fallback se nada for salvo no localStorage.
const initialQuestions = [
    { question: "Qual sistema operacional é conhecido por seu kernel de código aberto?", options: ["Windows", "macOS", "Linux", "Android"], answer: "Linux" },
    { question: "Qual empresa desenvolveu o sistema operacional Windows?", options: ["Apple", "Microsoft", "Google", "IBM"], answer: "Microsoft" },
    { question: "Qual é o principal sistema operacional usado em iPhones?", options: ["Android", "iOS", "Windows Phone", "BlackBerry OS"], answer: "iOS" },
    { question: "O que significa 'SO' na computação?", options: ["Sistema Operacional", "Software Online", "Servidor Obsoleto", "Segurança Operacional"], answer: "Sistema Operacional" },
    { question: "Qual dos seguintes não é um tipo de sistema operacional?", options: ["Multitarefa", "Monousuário", "Tempo Real", "Aplicativo de Texto"], answer: "Aplicativo de Texto" },
    { question: "Qual sistema operacional é amplamente usado em servidores web?", options: ["Windows", "macOS", "Linux", "Android"], answer: "Linux" },
    { question: "O que é um kernel?", options: ["Um tipo de vírus", "O núcleo do sistema operacional", "Uma linguagem de programação", "Um processador"], answer: "O núcleo do sistema operacional" },
    { question: "Qual é uma característica do sistema operacional de tempo real?", options: ["Interface gráfica avançada", "Respostas rápidas e previsíveis", "Compatibilidade com jogos", "Acesso offline"], answer: "Respostas rápidas e previsíveis" },
    { question: "Qual sistema operacional é desenvolvido pela Apple?", options: ["Windows", "Android", "macOS", "Ubuntu"], answer: "macOS" },
    { question: "Android é baseado em qual sistema operacional?", options: ["iOS", "Windows", "Linux", "DOS"], answer: "Linux" },
    { question: "Qual foi um dos primeiros sistemas operacionais?", options: ["Windows 10", "macOS", "UNIX", "Android"], answer: "UNIX" },
    { question: "Qual é a função de um sistema operacional?", options: ["Compilar código", "Gerenciar recursos do sistema", "Desenhar gráficos", "Enviar e-mails"], answer: "Gerenciar recursos do sistema" },
    { question: "Qual empresa desenvolve o Android?", options: ["Apple", "Google", "Microsoft", "IBM"], answer: "Google" },
    { question: "O que significa GUI?", options: ["Gerador de Unidade Interna", "Graphical User Interface", "Grupo de Usuários Interativo", "Gestor Universal de Interface"], answer: "Graphical User Interface" },
    { question: "Qual sistema operacional usa arquivos .apk?", options: ["iOS", "Linux", "Android", "Windows"], answer: "Android" },
    { question: "O Windows 11 é sucessor de qual versão?", options: ["Windows XP", "Windows 7", "Windows 10", "Windows Vista"], answer: "Windows 10" },
    { question: "Qual comando Linux lista arquivos e pastas?", options: ["cd", "mkdir", "ls", "rm"], answer: "ls" },
    { question: "O que é multitarefa?", options: ["Rodar múltiplos sistemas operacionais", "Rodar múltiplos programas simultaneamente", "Instalar múltiplos aplicativos", "Criar várias janelas"], answer: "Rodar múltiplos programas simultaneamente" },
    { question: "Qual é um exemplo de sistema operacional de código fechado?", options: ["Linux", "macOS", "FreeBSD", "Debian"], answer: "macOS" },
    { question: "O que é um sistema operacional embarcado?", options: ["Sistema para computadores de mesa", "Sistema para dispositivos móveis", "Sistema integrado em hardware específico", "Sistema para servidores"], answer: "Sistema integrado em hardware específico" },
    { question: "Qual comando do Linux apaga arquivos?", options: ["rm", "del", "erase", "remove"], answer: "rm" },
    { question: "Qual é uma distribuição do Linux?", options: ["Windows XP", "Fedora", "macOS", "Android"], answer: "Fedora" },
    { question: "Qual sistema operacional usa o Terminal como interface principal?", options: ["Windows", "Android", "Linux (modo texto)", "iOS"], answer: "Linux (modo texto)" },
    { question: "Qual é a principal linguagem usada no desenvolvimento do kernel Linux?", options: ["Java", "Python", "C", "Ruby"], answer: "C" },
    { question: "Qual sistema operacional ficou conhecido por sua interface gráfica em janelas?", options: ["UNIX", "DOS", "Windows", "CP/M"], answer: "Windows" },
    { question: "O que é um processo em um SO?", options: ["Um dispositivo físico", "Um programa em execução", "Um tipo de memória", "Uma atualização"], answer: "Um programa em execução" },
    { question: "Qual é o principal sistema de arquivos usado pelo Windows?", options: ["ext4", "HFS+", "NTFS", "FAT16"], answer: "NTFS" },
    { question: "Qual sistema de arquivos é comum em distribuições Linux?", options: ["NTFS", "FAT32", "ext4", "APFS"], answer: "ext4" },
    { question: "O que é um driver de dispositivo?", options: ["Um software para jogos", "Um programa que controla hardware", "Um vírus", "Uma linguagem de programação"], answer: "Um programa que controla hardware" },
    { question: "Qual é a função do gerenciador de arquivos?", options: ["Reproduzir vídeos", "Gerenciar pastas e arquivos", "Atualizar o sistema", "Proteger contra vírus"], answer: "Gerenciar pastas e arquivos" },
    { question: "O que é a BIOS?", options: ["Sistema operacional", "Software antivírus", "Firmware de inicialização", "Interface gráfica"], answer: "Firmware de inicialização" },
    { question: "Qual sistema operacional era comum em computadores antigos da IBM?", options: ["Windows 10", "DOS", "Android", "macOS"], answer: "DOS" },
    { question: "Qual ferramenta permite o controle remoto de sistemas Linux?", options: ["SSH", "FTP", "HTTP", "SMTP"], answer: "SSH" },
    { question: "O que é virtualização?", options: ["Usar arquivos compactados", "Executar sistemas em máquinas virtuais", "Proteger dados com senha", "Compactar software"], answer: "Executar sistemas em máquinas virtuais" },
    { question: "Qual sistema operacional é mais usado em supercomputadores?", options: ["Windows", "macOS", "Linux", "Chrome OS"], answer: "Linux" },
    { question: "O que é um sistema operacional monolítico?", options: ["Um que roda na nuvem", "Um com núcleo único e integrado", "Um com vários núcleos separados", "Sistema para celulares"], answer: "Um com núcleo único e integrado" },
    { question: "O que é swap no Linux?", options: ["Sistema de backup", "Memória de troca", "Atualização de software", "Interface gráfica"], answer: "Memória de troca" },
    { question: "Qual é uma vantagem do Linux?", options: ["Alta dependência de licença", "Código fechado", "Gratuito e personalizável", "Incompatibilidade com servidores"], answer: "Gratuito e personalizável" },
    { question: "O que significa boot?", options: ["Instalar um SO", "Inicializar o sistema", "Formatar disco", "Encerrar processo"], answer: "Inicializar o sistema" },
    { question: "Qual sistema operacional é usado no Raspberry Pi?", options: ["Windows 10", "Android", "Raspberry OS", "Chrome OS"], answer: "Raspberry OS" },
    { question: "Qual sistema operacional tem o comando PowerShell?", options: ["macOS", "Linux", "Windows", "Android"], answer: "Windows" },
    { question: "Qual é a principal interface do usuário no macOS?", options: ["Command Prompt", "Finder", "Terminal", "Nautilus"], answer: "Finder" },
    { question: "Qual comando cria uma nova pasta no Linux?", options: ["mkdir", "cd", "touch", "mv"], answer: "mkdir" },
    { question: "Qual é o principal sistema operacional da Google para notebooks?", options: ["Android", "Windows", "Chrome OS", "Linux Mint"], answer: "Chrome OS" },
    { question: "Em qual camada do sistema o kernel opera?", options: ["Aplicação", "Usuário", "Hardware", "Núcleo"], answer: "Núcleo" }
];

        // Usuários padrão. NOVOS usuários serão salvos no sessionStorage para persistência temporária.
        // ATENÇÃO: Este sistema de login é APENAS para demonstração. Não é seguro para uso em produção.
        let users = {
            "professor": { password: "admin123", type: "professor" },
            "aluno": { password: "aluno123", type: "aluno" }
        };

        // --- Variáveis de Estado do Quiz ---
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let quizStartTime = 0;
        let quizTimerInterval = null; // Timer geral do quiz (setInterval)
        let totalTimeElapsed = 0;    // Tempo real decorrido no quiz (sem penalidades adicionadas)
        let totalPenaltyWrongAnswer = 0;
        let totalPenaltyFocusLoss = 0;
        let userAnswers = [];        // Armazena detalhes de cada resposta para o relatório individual
        let currentUser = null;
        let currentUserType = null;

        // Variáveis por Questão
        let selectedOption = null;
        let questionStartTime = 0;
        let currentQuestionFocusPenalty = 0; // Penalidade de foco acumulada para a *questão atual*

        // Variáveis de Controle de Foco (para o cronômetro vermelho)
        let isQuizActive = false;    // Indica se o quiz está em andamento (e a penalidade pode ser aplicada)
        let isPageHidden = false;    // Indica se a página está oculta (aba trocada, minimizada)
        let hiddenStartTime = 0;     // Quando a página ficou oculta
        let penaltyDisplayInterval = null; // Intervalo para o cronômetro de penalidade no display

        // --- Seletores de Elementos HTML (Centralizados para Organização) ---
        const els = {
            loginArea: document.getElementById('login-area'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            loginButton: document.getElementById('login-button'),
            showRegisterButton: document.getElementById('show-register-button'),

            registerArea: document.getElementById('register-area'),
            newUsernameInput: document.getElementById('new-username'),
            newPasswordInput: document.getElementById('new-password'),
            registerUserButton: document.getElementById('register-user-button'),
            backToLoginButton: document.getElementById('back-to-login-button'),

            mainMenuArea: document.getElementById('main-menu-area'),
            startQuizButton: document.getElementById('start-quiz-button'),
            manageQuestionsButton: document.getElementById('manage-questions-button'),
            viewReportButton: document.getElementById('view-report-button'),
            exportGeneralReportButton: document.getElementById('export-general-report-button'), 
            logoutButton: document.getElementById('logout-button'),

            quizArea: document.getElementById('quiz-area'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            submitAnswerButton: document.getElementById('submit-answer-button'),
            feedbackMessage: document.getElementById('feedback-message'),
            timerDisplay: document.getElementById('timer'),
            currentScoreDisplay: document.getElementById('current-score'),
            penaltyStatusDisplay: document.getElementById('penalty-status'), // O cronômetro vermelho

            reportArea: document.getElementById('report-area'),
            reportStudentName: document.getElementById('report-student-name'),
            reportScore: document.getElementById('report-score'),
            reportTotalQuestions: document.getElementById('report-total-questions'),
            reportAverage: document.getElementById('report-average'),
            reportTimeTaken: document.getElementById('report-time-taken'),
            reportWrongAnswerPenaltyTime: document.getElementById('report-wrong-answer-penalty-time'),
            reportFocusPenaltyTime: document.getElementById('report-focus-penalty-time'),
            detailedResultsBody: document.getElementById('detailed-results-body'),
            exportPdfButton: document.getElementById('export-pdf-button'),
            backToMenuFromReportButton: document.getElementById('back-to-menu-from-report'),

            questionManagementArea: document.getElementById('question-management-area'),
            newQuestionText: document.getElementById('new-question-text'),
            newQuestionOptionsContainer: document.getElementById('new-question-options-container'),
            addQuestionButton: document.getElementById('add-question-button'),
            currentQuestionsList: document.getElementById('current-questions-list'),
            backToMenuFromManageButton: document.getElementById('back-to-menu-from-manage')
        };

        // --- Funções de Utilitário e Navegação ---
        /**
         * Alterna a visibilidade das seções da aplicação.
         * @param {string} sectionId - O ID da seção a ser mostrada.
         */
        function showSection(sectionId) {
            const sections = [
                els.loginArea, els.registerArea, els.mainMenuArea, 
                els.quizArea, els.reportArea, els.questionManagementArea
            ];
            sections.forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        /** Inicializa a aplicação ao carregar a página. */
        function initializeApp() {
            showSection('login-area');
            loadQuestions();
            loadUsers(); // Carrega usuários (do sessionStorage)
            updateMainMenuVisibility();
            // Adiciona listeners para detecção de perda de foco do navegador
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('focus', handleWindowFocus);
        }

        /** Carrega as perguntas do localStorage ou usa as iniciais. */
        function loadQuestions() {
            const storedQuestions = localStorage.getItem('quizQuestions');
            questions = storedQuestions ? JSON.parse(storedQuestions) : initialQuestions;
        }

        /** Salva as perguntas no localStorage. */
        function saveQuestions() {
            localStorage.setItem('quizQuestions', JSON.stringify(questions));
        }
        
        /** Carrega usuários do sessionStorage (se existirem) e mescla com os padrões. */
        function loadUsers() {
            const storedUsers = sessionStorage.getItem('quizUsers');
            if (storedUsers) {
                // Mescla os usuários salvos no sessionStorage com os usuários padrão fixos.
                // Isso permite que novos registros sejam persistidos temporariamente.
                Object.assign(users, JSON.parse(storedUsers));
            }
        }

        /** Salva usuários (apenas os registrados dinamicamente) no sessionStorage. */
        function saveUsers() {
            // Filtra os usuários fixos (professor/aluno) e salva apenas os registrados dinamicamente.
            const usersToSave = Object.fromEntries(
                Object.entries(users).filter(([username, userData]) => 
                    username !== "professor" && username !== "aluno"
                )
            );
            sessionStorage.setItem('quizUsers', JSON.stringify(usersToSave));
        }

        /** Atualiza a visibilidade dos botões do menu principal com base no tipo de usuário logado. */
        function updateMainMenuVisibility() {
            document.body.classList.toggle('admin-mode', currentUserType === 'professor');
        }

        // --- Lógica de Autenticação (Login e Registro) ---
        els.loginButton.addEventListener('click', () => {
            const username = els.usernameInput.value.trim();
            const password = els.passwordInput.value.trim();

            if (!username || !password) {
                alert("Por favor, preencha o usuário e a senha.");
                return;
            }

            if (users[username] && users[username].password === password) {
                currentUser = username;
                currentUserType = users[username].type;
                alert(`Bem-vindo(a), ${currentUser}!`);
                showSection('main-menu-area');
                els.usernameInput.value = '';
                els.passwordInput.value = '';
                updateMainMenuVisibility();
            } else {
                alert("Usuário ou senha incorretos!");
            }
        });

        els.logoutButton.addEventListener('click', () => {
            currentUser = null;
            currentUserType = null;
            isQuizActive = false; // Desativa a penalidade ao sair
            isPageHidden = false; // Reseta o estado de visibilidade
            stopPenaltyDisplayTimer(); // Garante que o cronômetro vermelho pare
            showSection('login-area');
            alert("Você foi desconectado(a).");
            updateMainMenuVisibility();
        });

        els.showRegisterButton.addEventListener('click', () => {
            showSection('register-area');
            els.newUsernameInput.value = '';
            els.newPasswordInput.value = '';
        });

        els.backToLoginButton.addEventListener('click', () => showSection('login-area'));

        els.registerUserButton.addEventListener('click', () => {
            const newUsername = els.newUsernameInput.value.trim();
            const newPassword = els.newPasswordInput.value.trim();

            if (!newUsername || !newPassword) {
                alert("Por favor, preencha o nome de usuário e a senha para registro.");
                return;
            }
            if (newPassword.length < 3) { // Exemplo de validação de senha
                alert("A senha deve ter no mínimo 3 caracteres.");
                return;
            }

            if (users[newUsername]) {
                alert(`O usuário '${newUsername}' já existe. Por favor, escolha outro nome de usuário.`);
                return;
            }
            
            // Adiciona o novo usuário com o tipo 'aluno' por padrão
            users[newUsername] = { password: newPassword, type: "aluno" };
            saveUsers(); // Salva os usuários (incluindo o novo) no sessionStorage
            
            alert(`Usuário '${newUsername}' registrado com sucesso! Você já pode fazer login.`);
            showSection('login-area'); // Volta para a tela de login
            els.usernameInput.value = newUsername; // Preenche o campo de login
            els.passwordInput.value = ''; // Limpa a senha
        });

        // --- Lógica do Quiz ---
        els.startQuizButton.addEventListener('click', () => {
            // Resetar variáveis de estado para um novo quiz
            currentQuestionIndex = 0;
            score = 0;
            totalTimeElapsed = 0;
            totalPenaltyWrongAnswer = 0;
            totalPenaltyFocusLoss = 0;
            userAnswers = []; // Limpa histórico de respostas
            quizStartTime = Date.now();
            
            // Limpa qualquer timer de quiz anterior e inicia um novo
            clearInterval(quizTimerInterval);
            quizTimerInterval = setInterval(updateQuizTimer, 1000);
            
            // Resetar UI do quiz
            els.submitAnswerButton.textContent = 'Próxima Pergunta';
            els.feedbackMessage.textContent = '';
            els.submitAnswerButton.disabled = false;

            // Ativar sistema de penalidade ao iniciar o quiz para alunos
            isQuizActive = (currentUserType === 'aluno');
            isPageHidden = false; // Começa como visível
            stopPenaltyDisplayTimer(); // Garante que o display de penalidade não esteja ativo inicialmente
            
            showSection('quiz-area');
            loadQuestion();
            updateQuizTimer(); // Atualiza a exibição do tempo imediatamente
        });

        /** Atualiza o timer do quiz na tela. */
        function updateQuizTimer() {
            totalTimeElapsed = Math.floor((Date.now() - quizStartTime) / 1000);
            els.timerDisplay.textContent = `Tempo: ${totalTimeElapsed}s`;
            els.currentScoreDisplay.textContent = `Acertos: ${score}`;
        }

        /** Carrega a próxima pergunta na interface do quiz. */
        function loadQuestion() {
            // Limpa feedback e seleção da pergunta anterior
            els.feedbackMessage.textContent = '';
            els.feedbackMessage.className = ''; // Remove classes de estilo
            selectedOption = null;
            currentQuestionFocusPenalty = 0; // Zera a penalidade de foco para a *nova* questão

            if (currentQuestionIndex < questions.length) {
                const q = questions[currentQuestionIndex];
                // Usar textContent para prevenir XSS
                els.questionText.textContent = q.question; 
                els.optionsContainer.innerHTML = ''; // Limpa opções anteriores

                q.options.forEach((option) => {
                    const button = document.createElement('button');
                    // Usar textContent para prevenir XSS
                    button.textContent = option; 
                    button.onclick = () => selectOption(button, option);
                    els.optionsContainer.appendChild(button);
                });
                els.submitAnswerButton.disabled = false; // Reabilita o botão para a nova pergunta
                questionStartTime = Date.now(); // Marca o início do tempo para esta pergunta
            } else {
                // Fim do quiz: para timers e exibe o relatório
                clearInterval(quizTimerInterval);
                isQuizActive = false; // Desativa a penalidade ao finalizar o quiz
                isPageHidden = false; // Reseta estado de visibilidade
                stopPenaltyDisplayTimer(); // Garante que o cronômetro vermelho pare e suma

                // SALVA O RESULTADO DO QUIZ NO ARMAZENAMENTO GERAL
                saveQuizResult({
                    studentName: currentUser,
                    score: score,
                    totalQuestions: questions.length,
                    averagePercentage: parseFloat(((score / questions.length) * 100).toFixed(2)),
                    totalTimeSeconds: totalTimeElapsed,
                    penaltyWrongAnswerSeconds: totalPenaltyWrongAnswer,
                    penaltyFocusLossSeconds: totalPenaltyFocusLoss,
                    detailedResults: userAnswers,
                    timestamp: new Date().toLocaleString() // Adiciona um timestamp
                });

                showReport({ // Passa os dados do quiz atual para o relatório individual
                    studentName: currentUser,
                    score: score,
                    totalQuestions: questions.length,
                    averagePercentage: parseFloat(((score / questions.length) * 100).toFixed(2)),
                    totalTimeSeconds: totalTimeElapsed,
                    penaltyWrongAnswerSeconds: totalPenaltyWrongAnswer,
                    penaltyFocusLossSeconds: totalPenaltyFocusLoss,
                    detailedResults: userAnswers,
                    timestamp: new Date().toLocaleString()
                }); 
            }
        }

        /**
         * Seleciona uma opção de resposta visualmente.
         * @param {HTMLButtonElement} button - O botão da opção clicado.
         * @param {string} optionValue - O texto da opção selecionada.
         */
        function selectOption(button, optionValue) {
            // Remove a classe 'selected' de todos os botões de opção
            Array.from(els.optionsContainer.children).forEach(btn => {
                btn.classList.remove('selected');
            });
            // Adiciona a classe 'selected' ao botão clicado
            button.classList.add('selected');
            selectedOption = optionValue;
        }

        els.submitAnswerButton.addEventListener('click', () => {
            if (!selectedOption) {
                alert("Por favor, selecione uma resposta antes de continuar.");
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];
            const isCorrect = (selectedOption === currentQuestion.answer);
            // O tempo gasto na questão agora inclui a penalidade de foco acumulada para ela
            const timeTakenForQuestion = Math.floor((Date.now() - questionStartTime) / 1000) + currentQuestionFocusPenalty;

            // Armazenar detalhes da resposta para o relatório
            userAnswers.push({
                questionNum: currentQuestionIndex + 1,
                questionText: currentQuestion.question,
                userAnswer: selectedOption,
                correctAnswer: currentQuestion.answer,
                isCorrect: isCorrect,
                timeTaken: timeTakenForQuestion, // Tempo real gasto nesta questão + penalidade de foco
                focusPenalty: currentQuestionFocusPenalty // Penalidade de foco específica para esta questão
            });

            if (isCorrect) {
                score++;
                els.feedbackMessage.textContent = "Correto!";
                els.feedbackMessage.classList.add('correct');
            } else {
                els.feedbackMessage.textContent = `Incorreto! A resposta correta era: "${currentQuestion.answer}"`;
                els.feedbackMessage.classList.add('incorrect');
                totalPenaltyWrongAnswer += PENALTY_WRONG_ANSWER_SECONDS; // Penalidade global por resposta errada
            }

            // Desabilita botões de opção e atualiza visual
            Array.from(els.optionsContainer.children).forEach(btn => {
                btn.disabled = true; // Desabilita todos os botões de opção
                if (btn.textContent === currentQuestion.answer) {
                    btn.classList.add('correct');
                } else if (btn.textContent === selectedOption && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });

            els.submitAnswerButton.textContent = 'Próxima Pergunta';
            els.submitAnswerButton.disabled = true; // Desabilita o botão "Próxima Pergunta" temporariamente

            currentQuestionIndex++;
            // Pequeno atraso para o usuário ver o feedback antes de carregar a próxima pergunta
            setTimeout(() => {
                loadQuestion();
            }, QUIZ_FEEDBACK_DELAY_MS);
        });

        // --- Lógica do Relatório Individual ---
        els.viewReportButton.addEventListener('click', () => {
            if (currentUserType !== 'professor') {
                alert('Acesso negado. Apenas professores podem ver o relatório individual (o último quiz realizado).');
                return;
            }
            // Para professores, o relatório individual exibirá o último quiz salvo globalmente
            const allQuizResults = loadAllQuizResults();
            if (allQuizResults.length > 0) {
                 // Mostra o último quiz registrado
                showReport(allQuizResults[allResults.length - 1]);
            } else {
                alert('Nenhum relatório de quiz disponível para visualização.');
                showSection('main-menu-area');
            }
        });

        /** * Gera e exibe o relatório de um quiz específico.
         * @param {Object} quizData - Os dados de um quiz concluído.
         */
        function showReport(quizData) {
            showSection('report-area');
            els.reportStudentName.textContent = quizData.studentName || 'N/A';
            els.reportScore.textContent = quizData.score;
            els.reportTotalQuestions.textContent = quizData.totalQuestions;

            els.reportAverage.textContent = quizData.averagePercentage;

            els.reportTimeTaken.textContent = quizData.totalTimeSeconds;
            els.reportWrongAnswerPenaltyTime.textContent = quizData.penaltyWrongAnswerSeconds;
            els.reportFocusPenaltyTime.textContent = quizData.penaltyFocusLossSeconds;

            els.detailedResultsBody.innerHTML = ''; // Limpa resultados anteriores
            quizData.detailedResults.forEach((answer, index) => {
                const row = els.detailedResultsBody.insertRow();
                row.insertCell().textContent = answer.questionNum;
                row.insertCell().textContent = answer.questionText;
                row.insertCell().textContent = answer.userAnswer;
                row.insertCell().textContent = answer.correctAnswer;
                row.insertCell().textContent = answer.isCorrect ? 'Correta' : 'Incorreta';
                row.insertCell().textContent = answer.timeTaken;
                row.insertCell().textContent = answer.focusPenalty;
            });
        }

        els.backToMenuFromReportButton.addEventListener('click', () => showSection('main-menu-area'));

        // --- Armazenamento e Exportação de Relatórios GERAIS (Para Professor) ---

        /** * Carrega todos os resultados de quiz salvos no localStorage.
         * @returns {Array<Object>} Uma array de objetos de relatório de quiz.
         */
        function loadAllQuizResults() {
            const storedResults = localStorage.getItem('allQuizResults');
            return storedResults ? JSON.parse(storedResults) : [];
        }

        /** * Salva um único resultado de quiz no armazenamento geral.
         * @param {Object} quizResult - O objeto do relatório de um quiz concluído.
         */
        function saveQuizResult(quizResult) {
            const allResults = loadAllQuizResults();
            allResults.push(quizResult);
            localStorage.setItem('allQuizResults', JSON.stringify(allResults));
            console.log(`Relatório do quiz de ${quizResult.studentName} salvo. Total de relatórios: ${allResults.length}`);
        }
        
        // Listener para o novo botão de exportar relatório geral
        els.exportGeneralReportButton.addEventListener('click', exportGeneralReportToCsv);

        /**
         * Exporta um relatório consolidado de todos os quizzes para um arquivo CSV.
         */
        function exportGeneralReportToCsv() {
            if (currentUserType !== 'professor') {
                alert('Acesso negado. Apenas professores podem exportar o relatório geral.');
                return;
            }

            const allQuizResults = loadAllQuizResults();

            if (allQuizResults.length === 0) {
                alert('Nenhum relatório de quiz disponível para exportação.');
                return;
            }

            let csvContent = '';

            // Cabeçalho CSV (campos gerais do quiz)
            const generalHeaders = [
                "Data/Hora", "Nome do Aluno", "Acertos", "Total de Perguntas", 
                "Porcentagem de Acerto", "Tempo Total do Quiz (s)", 
                "Penalidade Respostas Erradas (s)", "Penalidade Perda Foco (s)"
            ];
            csvContent += generalHeaders.join(';') + '\n'; // Usa ponto e vírgula como delimitador para Excel

            // Adiciona as linhas gerais de cada quiz
            allQuizResults.forEach(quiz => {
                const row = [
                    quiz.timestamp,
                    quiz.studentName,
                    quiz.score,
                    quiz.totalQuestions,
                    quiz.averagePercentage,
                    quiz.totalTimeSeconds,
                    quiz.penaltyWrongAnswerSeconds,
                    quiz.penaltyFocusLossSeconds
                ].map(item => `"${String(item).replace(/"/g, '""')}"`); // Escapa aspas duplas e envolve em aspas
                csvContent += row.join(';') + '\n';
            });

            // Adiciona uma linha em branco para separar os detalhes
            csvContent += '\n';

            // Adiciona o cabeçalho para os detalhes das perguntas
            const detailHeaders = [
                "Nome do Aluno (Detalhe)", "Pergunta #", "Pergunta", "Sua Resposta", 
                "Resposta Correta", "Status", "Tempo na Questão (s)", "Penalidade Foco (s)"
            ];
            csvContent += detailHeaders.join(';') + '\n';

            // Adiciona as linhas detalhadas de cada pergunta de CADA quiz
            allQuizResults.forEach(quiz => {
                quiz.detailedResults.forEach(detail => {
                    const row = [
                        quiz.studentName, // Repete o nome do aluno para cada detalhe
                        detail.questionNum,
                        detail.questionText,
                        detail.userAnswer,
                        detail.correctAnswer,
                        detail.isCorrect ? 'Correta' : 'Incorreta',
                        detail.timeTaken,
                        detail.focusPenalty
                    ].map(item => `"${String(item).replace(/"/g, '""')}"`);
                    csvContent += row.join(';') + '\n';
                });
            });

            // Cria um Blob e dispara o download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date();
            const filename = `relatorio_geral_quizzes_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Libera o objeto URL
            
            alert('Relatório geral exportado com sucesso para um arquivo Excel (CSV)!');
        }


        // --- Lógica de Gerenciamento de Perguntas (Apenas para Professor) ---
        els.manageQuestionsButton.addEventListener('click', () => {
            if (currentUserType !== 'professor') {
                alert('Acesso negado. Apenas professores podem gerenciar perguntas.');
                return;
            }
            showSection('question-management-area');
            renderQuestionsList(); // Atualiza a lista de perguntas ao entrar
        });

        /** Renderiza a lista de perguntas para gerenciamento. */
        function renderQuestionsList() {
            els.currentQuestionsList.innerHTML = '';
            if (questions.length === 0) {
                els.currentQuestionsList.textContent = 'Nenhuma pergunta cadastrada.';
                return;
            }
            questions.forEach((q, index) => {
                const item = document.createElement('div');
                item.classList.add('question-list-item');
                item.innerHTML = `
                    <span class="question-text">${index + 1}. ${q.question}</span>
                    <div>
                        <button class="action-button danger" onclick="deleteQuestion(${index})">Excluir</button>
                    </div>
                `;
                els.currentQuestionsList.appendChild(item);
            });
        }

        els.addQuestionButton.addEventListener('click', () => {
            const questionTextValue = els.newQuestionText.value.trim();
            const optionInputs = els.newQuestionOptionsContainer.querySelectorAll('.new-option-text');
            const radioInputs = els.newQuestionOptionsContainer.querySelectorAll('.new-option-radio');

            const options = [];
            let correctAnswer = null;

            optionInputs.forEach((input, index) => {
                const optionValue = input.value.trim();
                if (optionValue) { // Apenas adiciona opções não vazias
                    options.push(optionValue);
                    if (radioInputs[index] && radioInputs[index].checked) {
                        correctAnswer = optionValue; // Pega o texto da opção selecionada como resposta correta
                    }
                }
            });

            if (!questionTextValue) {
                alert("Por favor, digite o texto da pergunta.");
                return;
            }
            if (options.length < 2) {
                alert("Por favor, forneça pelo menos duas opções de resposta.");
                return;
            }
            if (!correctAnswer) {
                alert("Por favor, selecione uma resposta correta.");
                return;
            }

            questions.push({
                question: questionTextValue,
                options: options,
                answer: correctAnswer
            });

            saveQuestions();
            renderQuestionsList();
            alert("Pergunta adicionada com sucesso!");

            // Limpar formulário após adicionar
            els.newQuestionText.value = '';
            optionInputs.forEach(input => input.value = '');
            radioInputs.forEach(radio => radio.checked = false);
        });

        /**
         * Exclui uma pergunta da lista.
         * @param {number} index - O índice da pergunta a ser excluída.
         */
        function deleteQuestion(index) {
            if (confirm(`Tem certeza que deseja excluir a pergunta "${questions[index].question}"?`)) {
                questions.splice(index, 1); // Remove a pergunta pelo índice
                saveQuestions();
                renderQuestionsList();
                alert("Pergunta excluída com sucesso!");
            }
        }

        els.backToMenuFromManageButton.addEventListener('click', () => showSection('main-menu-area'));

        // --- Funções de Controle de Foco/Visibilidade e Penalidade ---
        /** Inicia o cronômetro visual de penalidade (vermelho). */
        function startPenaltyDisplayTimer() {
            clearInterval(penaltyDisplayInterval); // Garante que apenas um timer esteja rodando
            els.penaltyStatusDisplay.classList.add('active'); // Ativa o estilo vermelho
            penaltyDisplayInterval = setInterval(() => {
                // Atualiza o display apenas se a página estiver oculta e o quiz ativo
                if (isPageHidden && isQuizActive) {
                    const timeHiddenNow = Math.floor((Date.now() - hiddenStartTime) / 1000);
                    // Garante que a penalidade mostrada no display seja sempre no mínimo MIN_FOCUS_PENALTY_SECONDS
                    const displayPenalty = Math.max(MIN_FOCUS_PENALTY_SECONDS, timeHiddenNow * FOCUS_PENALTY_PER_SECOND);
                    els.penaltyStatusDisplay.textContent = `Tempo fora da prova: ${displayPenalty}s`;
                }
            }, 500); // Atualiza a cada 0.5 segundos
        }

        /** Para o cronômetro visual de penalidade e o oculta. */
        function stopPenaltyDisplayTimer() {
            clearInterval(penaltyDisplayInterval);
            els.penaltyStatusDisplay.classList.remove('active'); // Remove o estilo vermelho
            els.penaltyStatusDisplay.textContent = 'Tempo fora da prova: 0s'; // Reseta o texto
        }

        /** Lida com as mudanças de visibilidade da página (aba trocada/minimizada). */
        function handleVisibilityChange() {
            if (!isQuizActive) return; // Só aplica penalidade se o quiz estiver ativo

            if (document.hidden) {
                // A página foi minimizada ou a aba foi trocada
                isPageHidden = true;
                hiddenStartTime = Date.now(); // Marca o início da ocultação
                startPenaltyDisplayTimer();
                console.warn("Página oculta (document.hidden): Penalidade de foco ativada.");
            } else {
                // A página voltou a ser visível
                if (isPageHidden) { // Aplica a penalidade se realmente estava oculta
                    const timeHidden = Math.floor((Date.now() - hiddenStartTime) / 1000);
                    const calculatedPenalty = Math.max(MIN_FOCUS_PENALTY_SECONDS, timeHidden * FOCUS_PENALTY_PER_SECOND);
                    currentQuestionFocusPenalty += calculatedPenalty; // Adiciona à penalidade da questão atual
                    totalPenaltyFocusLoss += calculatedPenalty; // Adiciona à penalidade total de foco
                    console.log(`Página visível novamente. Tempo oculto: ${timeHidden}s. Penalidade aplicada à questão atual: ${calculatedPenalty}s.`);
                }
                isPageHidden = false; // Reseta o estado
                stopPenaltyDisplayTimer();
            }
        }

        /** Lida com a perda de foco da janela (ex: Alt+Tab, clique fora da janela). */
        function handleWindowBlur() {
            // Se o quiz não está ativo ou a página já está oculta (document.hidden), não faz nada.
            // O document.hidden já foi capturado por handleVisibilityChange.
            if (!isQuizActive || document.hidden) return; 
            
            isPageHidden = true;
            hiddenStartTime = Date.now();
            startPenaltyDisplayTimer();
            console.warn("Janela perdeu o foco (window.blur): Penalidade de foco ativada.");
        }

        /** Lida com o ganho de foco da janela. */
        function handleWindowFocus() {
            // Se o quiz não está ativo ou a página não estava marcada como oculta, não faz nada.
            if (!isQuizActive || !isPageHidden) return; 

            const timeBlurred = Math.floor((Date.now() - hiddenStartTime) / 1000);
            const calculatedPenalty = Math.max(MIN_FOCUS_PENALTY_SECONDS, timeBlurred * FOCUS_PENALTY_PER_SECOND);
            currentQuestionFocusPenalty += calculatedPenalty; // Adiciona à penalidade da questão atual
            totalPenaltyFocusLoss += calculatedPenalty; // Adiciona à penalidade total de foco
            console.log(`Janela recuperou o foco. Tempo fora de foco: ${timeBlurred}s. Penalidade aplicada à questão atual: ${calculatedPenalty}s.`);
            
            isPageHidden = false; // Reseta o estado
            stopPenaltyDisplayTimer();
        }

        // --- Inicialização da Aplicação ---
        initializeApp();
    </script>
</body>
</html>
